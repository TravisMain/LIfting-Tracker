<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Advanced Fitness Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Google Fonts: Montserrat for headings, Nunito for body -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#F8FAF9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lifting Tracker">
    <meta name="format-detection" content="telephone=no">
    <style>
        html { -webkit-text-size-adjust: 100%; }
        :root {
            --finisher-bg: #fff1f0;
            --finisher-border: #f87171;
            --finisher-text: #b91c1c;
            --suggestion-red: #ef4444;
            --background: #F8FAF9;
            --surface-1: #FDFDFD;
            --surface-2: #F3F4F6;
            --primary: #475569; /* slate-600 */
            --primary-light: #94a3b8; /* slate-400 */
            --secondary: #64748b; /* slate-500 */
            --accent: #a3e635; /* lime-400, subtle accent */
            --text-on-bg: #23272A;
            --text-on-surface: #23272A;
            --text-muted: #6B7280;
            --border-color: #E2E8F0;
            --shadow: 0 2px 8px rgba(44, 62, 80, 0.04);
            --spacing-8: 8px;
            --spacing-16: 16px;
            --spacing-24: 24px;
            --spacing-32: 32px;
            --border-radius: 10px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', Arial, sans-serif;
            background: var(--background);
            color: var(--text-on-bg);
            line-height: 1.7;
            margin: 0;
        }

        /* Recommended Plans: visually smaller, less prominent */
        #recommended-plans {
            background: var(--surface-2);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            margin: 12px 0 0 0;
            box-shadow: none;
            opacity: 0.85;
        }
        #recommended-plans summary {
            font-size: 1em;
            font-weight: 600;
            color: var(--primary-light);
            padding: 10px 16px;
        }
        #recommended-content {
            font-size: 0.95em;
            color: var(--text-muted);
        }

        /* Quick Log Modal: scrollable for mobile */
        #quick-log-modal .modal-scroll {
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: 8px;
        }
        @media (max-width: 480px) {
            #quick-log-modal .modal-scroll { max-height: 70vh; }
        }

        /* What's New Modal Styles */
        #whats-new-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25);
            z-index: 2100;
            align-items: flex-end;
            justify-content: center;
        }
        #whats-new-modal .modal-content {
            background: #fff;
            padding: 20px 16px calc(16px + env(safe-area-inset-bottom, 0px));
            border-radius: 14px 14px 0 0;
            max-width: 640px;
            width: 100vw;
            margin: 0;
            box-shadow: 0 -6px 24px rgba(44,62,80,0.16);
            text-align: left;
            max-height: 90vh;
            overflow-y: auto;
        }
        #whats-new-modal h2 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.35em;
        }
        #whats-new-modal ul {
            margin: 16px 0 0 0;
            padding-left: 20px;
        }
        #whats-new-modal button {
            margin-top: 24px;
            width: 100%;
        }

        /* Base layout */
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 16px;
        }
        header {
            position: static;
            padding: 12px 16px;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-color);
            box-shadow: none;
        }
        header h1 {
            font-family: 'Montserrat', Arial, sans-serif;
            font-weight: 900;
            font-size: 1.75em;
            letter-spacing: 0.5px;
            margin: 8px 0 16px 0;
            color: var(--primary);
        }
        .section {
            background: var(--surface-1);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-16);
            margin-bottom: var(--spacing-24);
            box-shadow: var(--shadow);
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: var(--spacing-16);
        }
        @media (max-width: 640px) {
            .input-grid { grid-template-columns: 1fr; }
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 1em;
            color: var(--primary);
            margin-bottom: var(--spacing-8);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: var(--spacing-8) var(--spacing-16);
            background-color: var(--surface-2);
            border: 1px solid var(--border-color);
            color: var(--text-on-bg);
            border-radius: 8px;
            font-size: 1.1em;
            font-family: 'Nunito', Arial, sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
            outline: none;
        }

        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: var(--spacing-8) var(--spacing-16);
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            text-align: center;
            box-shadow: 0 2px 8px rgba(44, 62, 80, 0.06);
        }
        .btn:hover {
            background: var(--secondary);
            color: #fff;
            box-shadow: 0 4px 16px rgba(44, 62, 80, 0.08);
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--primary);
        }
        .btn-secondary:hover {
            background: #d9f99d;
            color: var(--primary);
        }

        #measurements-section .btn { margin-top: var(--spacing-16); }

        /* Remove old nav button styles for tab navigation */

    /* Bottom tab bar styles */
        .tab-bar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background: var(--surface-2);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: calc(60px + env(safe-area-inset-bottom, 0px));
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 100;
            box-shadow: 0 -2px 8px rgba(44,62,80,0.04);
        }
        .tab-bar-btn {
            flex: 1;
            text-align: center;
            background: none;
            border: none;
            color: var(--primary);
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 1em;
            font-weight: 700;
            padding: 0;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
        }
        .tab-bar-btn.active {
            color: var(--accent);
        }
        .tab-bar-btn svg {
            display: block;
            margin: 0 auto 2px auto;
            height: 24px;
            width: 24px;
        }
        /* Increase tap target for bottom nav on phones */
        .tab-bar-btn { min-height: 56px; }
        @media (min-width: 768px) {
            .tab-bar { max-width: 900px; left: 50%; transform: translateX(-50%); }
        }

        /* (Removed) Bottom Action Bar styles */
        .phase-content.active { display: block; }

        .workout-day {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-24);
            background: var(--surface-1);
            box-shadow: none;
        }
        .workout-day summary {
            padding: var(--spacing-16);
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            color: var(--primary);
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .workout-day[open] summary { border-bottom: 2px solid var(--primary); }
        .workout-content {
            padding: var(--spacing-16);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-16);
        }

        /* Stats: mobile-friendly tables */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-scroll table { min-width: 640px; }
        .table-scroll thead th { position: sticky; top: 0; background: #f3f4f6; z-index: 1; }

        /* Collapsible section styling */
        .stats-accordion details { border: 1px solid var(--border-color); border-radius: var(--border-radius); background: var(--surface-1); margin-bottom: var(--spacing-16); }
        .stats-accordion summary { list-style: none; cursor: pointer; padding: var(--spacing-16); font-weight: 700; font-size: 1.1em; display: flex; align-items: center; gap: 8px; color: var(--primary); }
        .stats-accordion summary::before { content: '\25B6'; display: inline-block; transform: rotate(0deg); transition: transform 0.2s; color: var(--primary); }
        .stats-accordion details[open] summary::before { transform: rotate(90deg); }
        .stats-accordion .section-body { padding: 0 var(--spacing-16) var(--spacing-16); }

        @media (max-width: 480px) {
            h2 { font-size: 1.25em; }
            h3 { font-size: 1.1em; }
            .table-scroll table { min-width: 520px; }
            /* Hide Type column in past workouts for narrower screens */
            #past-workouts-table table th:nth-child(3),
            #past-workouts-table table td:nth-child(3) { display: none; }
        }

        .exercise-card {
            background: var(--surface-2);
            border-radius: var(--border-radius);
            padding: var(--spacing-24);
            box-shadow: none;
        }
        .exercise-card.finisher {
            background: var(--finisher-bg);
            border: 2px solid var(--finisher-border);
            color: var(--finisher-text);
        }

        .suggestion {
            font-size: 1em;
            color: var(--suggestion-red);
            margin-top: var(--spacing-8);
            font-style: italic;
            font-weight: 700;
        }

        #dashboard-section .chart-container { margin-top: var(--spacing-24); }
        #dashboard-section label { margin-right: var(--spacing-8); }

        /* Chart.js canvas tweaks */
        .chart-container {
            width: 100%;
            max-width: 100vw;
            min-width: 0;
            overflow-x: auto;
            padding: 0 4px;
        }
        canvas {
            background: var(--surface-2);
            border-radius: 8px;
            box-shadow: none;
            width: 100% !important;
            height: 220px !important;
            max-width: 100vw;
            min-width: 0;
        }
        @media (max-width: 767px) {
            .chart-container { padding: 0 2px; }
            canvas { height: 160px !important; }
        }

        /* Phase navigation: clearer active state */
        .phase-nav { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-8); margin: var(--spacing-16) 0; }
        .phase-btn { background: var(--surface-2); color: var(--primary); border: 1px solid var(--border-color); border-radius: 10px; }
    .phase-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* More noticeable pastel green backgrounds for phases */
    #workout-section.phase-1 { background: #fafcf7; /* ultra subtle green tint */ }
    #workout-section.phase-2 { background: #f7fcfa; /* ultra subtle mint tint */ }
    #workout-section.phase-3 { background: #f7fbfc; /* ultra subtle aqua tint */ }

        /* Mobile: allow tables to scroll horizontally */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-scroll table { min-width: 640px; }
        /* Mobile card styles for small screens */
        .mobile-pw-card, .mobile-measure-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.04);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .mobile-pw-card .pw-top { display:flex;justify-content:space-between;align-items:center;gap:8px; }
        .mobile-pw-card .pw-meta { display:flex;gap:8px;flex-wrap:wrap;color:var(--text-muted);font-size:0.95em }
        .mobile-measure-card .measure-grid { display:flex;gap:8px;flex-wrap:wrap; }
        @media (max-width: 767px) {
            .table-scroll table { font-size: 0.9em; }
            .table-scroll th, .table-scroll td { padding: 4px 8px; }
        }

        /* Improve tap targets on mobile */
        .btn, .tab-bar-btn, .phase-btn { min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        input, select { min-height: 40px; }
    /* Avoid content sitting under fixed tab bar */
    /* Ensure content does not sit behind action + tab bars */
    #main-pastworkouts { padding-bottom: 92px; }
    #main-dashboard { padding-bottom: 92px; }
        body { overscroll-behavior-y: contain; }
        summary { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>

    <!-- Update Snackbar (non-blocking) -->
    <div id="update-snackbar" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.2);z-index:2200;align-items:center;gap:8px;">
        <span id="update-msg">A new version is available.</span>
        <button id="update-reload" class="btn" style="margin-left:10px;">Reload</button>
        <button id="update-dismiss" class="btn btn-secondary" style="margin-left:6px;">Dismiss</button>
    </div>

    <!-- What's New Modal -->
    <div id="whats-new-modal">
        <div class="modal-content">
            <h2>What's New (v2)</h2>
            <ul>
                <li><strong>QR Share & Scan:</strong> Instantly share your workout plan offline via QR code, or scan a friend's plan to import.</li>
                <li><strong>Style Restored:</strong> Layout, cards, and mobile-friendly design are back and better than ever.</li>
                <li><strong>Cache Refresh:</strong> Updates now reach all users reliably—no more stale assets.</li>
            </ul>
            <button class="btn" id="whats-new-close">Got it!</button>
        </div>
    </div>
    <!-- Exercise Picker Modal (Bottom Sheet) -->
    <div id="exercise-picker-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2002;align-items:flex-end;justify-content:center;">
        <div style="background:#fff;padding:20px 16px calc(16px + env(safe-area-inset-bottom, 0px));border-radius:14px 14px 0 0;max-width:640px;width:100vw;margin:0;box-shadow:0 -6px 24px rgba(44,62,80,0.16);max-height:90vh;overflow-y:auto;">
            <h2 style="color:var(--primary);margin-top:0;margin-bottom:12px;">Select Exercise</h2>
            <div style="margin-bottom:12px;">
                <label for="muscle-filter" style="font-weight:600;color:#2e7d32;">Filter by Muscle Group:</label>
                <select id="muscle-filter" style="width:100%;margin-top:4px;padding:8px;border-radius:8px;border:1px solid #E2E8F0;">
                    <option value="">All</option>
                </select>
            </div>
            <input type="text" id="exercise-search" placeholder="Search exercises..." style="width:100%;margin-bottom:12px;padding:8px 12px;border-radius:8px;border:1px solid #E2E8F0;font-size:1em;">
            <div id="exercise-list" style="max-height:320px;overflow-y:auto;"></div>
            <div id="exercise-attrib" style="margin-top:8px;color:var(--text-muted);font-size:0.85em;">
                Exercise data may include contributions from the Exercemus dataset (CC BY-SA).
            </div>
            <button class="btn btn-secondary" type="button" id="exercise-picker-cancel" style="margin-top:16px;width:100%;">Cancel</button>
        </div>
    </div>
    <!-- Create Workout Plan Modal (Bottom Sheet) -->
    <div id="create-plan-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2001;align-items:flex-end;justify-content:center;">
        <div style="background:#fff;padding:20px 16px calc(16px + env(safe-area-inset-bottom, 0px));border-radius:14px 14px 0 0;max-width:640px;width:100vw;margin:0;box-shadow:0 -6px 24px rgba(44,62,80,0.16);max-height:90vh;overflow-y:auto;">
            <h2 style="color:var(--primary);margin-top:0;margin-bottom:18px;">Create Workout Plan</h2>
            <form id="create-plan-form">
                <div class="input-group" style="margin-bottom:18px;">
                    <label for="plan-day">Day</label>
                    <input type="text" id="plan-day" required placeholder="e.g., Monday">
                </div>
                <hr style="border:none;border-top:1px solid #E2E8F0;margin:12px 0;">
                <div id="exercise-fields"></div>
                                <button type="button" class="btn btn-secondary" id="add-exercise-btn" title="Add Exercise" style="margin-bottom:16px;display:flex;align-items:center;justify-content:center;padding:6px 10px;">
                                    <span style="display:inline-block;width:1.5em;height:1.5em;">
                                        <!-- Plus/Add SVG icon -->
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                            <rect x="11" y="4" width="2" height="16" rx="1"/>
                                            <rect x="4" y="11" width="16" height="2" rx="1"/>
                                        </svg>
                                    </span>
                                </button>
                <div id="plan-summary" style="margin-bottom:18px;"></div>
                <div style="display:flex;flex-direction:column;gap:12px;margin-top:24px;">
                    <button class="btn" type="submit" style="font-size:1.15em;">Save Day</button>
                    <button class="btn btn-secondary" type="button" style="font-size:1.15em;" onclick="closeCreatePlanModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="user-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 24px;border-radius:12px;max-width:350px;margin:auto;box-shadow:0 4px 24px rgba(44,62,80,0.12);">
            <h2 style="color:var(--primary);margin-top:0;">Welcome!</h2>
            <p style="color:var(--text-muted);margin-bottom:16px;">Let's get started on your fitness journey! Please tell us a bit about yourself so we can tailor your program to your goals and preferences.</p>
            <form id="user-details-form">
                <div class="input-group">
                    <label for="user-name">Your Name</label>
                    <input type="text" id="user-name" required placeholder="e.g., Alex" autocomplete="name" autocapitalize="words" enterkeyhint="next">
                </div>
                <div class="input-group">
                    <label for="user-age">Age</label>
                    <input type="number" id="user-age" min="10" max="120" required placeholder="e.g., 30" inputmode="numeric" step="1" enterkeyhint="next">
                </div>
                <div class="input-group">
                    <label for="user-goal">Main Goal</label>
                    <select id="user-goal" required enterkeyhint="done">
                        <option value="">Select your main goal...</option>
                        <option value="Build muscle">Build muscle</option>
                        <option value="Lose fat">Lose fat</option>
                        <option value="Increase strength">Increase strength</option>
                        <option value="Improve endurance">Improve endurance</option>
                        <option value="General fitness">General fitness</option>
                        <option value="Rehabilitation">Rehabilitation</option>
                        <option value="Athletic performance">Athletic performance</option>
                        <option value="Healthy aging">Healthy aging</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button class="btn" type="submit" style="margin-top:16px;width:100%;">Start Program</button>
            </form>
        </div>
    </div>

    <!-- Quick Log Modal (Bottom Sheet) -->

    <div id="quick-log-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2001;align-items:flex-end;justify-content:center;">
        <div style="background:#fff;padding:20px 16px calc(16px + env(safe-area-inset-bottom, 0px));border-radius:14px 14px 0 0;max-width:640px;width:100vw;margin:0;box-shadow:0 -6px 24px rgba(44,62,80,0.16);display:flex;flex-direction:column;max-height:90vh;overflow-y:auto;">
            <h2 style="color:var(--primary);margin-top:0;">Quick Log</h2>
            <div class="modal-scroll">
                <form id="quick-log-form">
                    <div class="input-group" style="margin-bottom:8px;">
                        <label for="quick-exercise-input">Exercise</label>
                        <input type="text" id="quick-exercise-input" required placeholder="Select or type exercise..." style="background:#f3f4f6;cursor:pointer;" autocomplete="off">
                        <button type="button" class="btn btn-secondary" style="margin-top:4px;" id="quick-choose-exercise-btn">Choose</button>
                    </div>
                    <p id="quick-suggestion" style="color:var(--text-muted);margin:4px 0 12px 0;"></p>
                    <div class="input-group">
                        <label for="quick-sets">Sets</label>
                        <input type="number" id="quick-sets" min="1" max="10" required placeholder="e.g., 3" value="3">
                    </div>
                    <div id="quick-set-inputs-container" class="input-grid" style="margin-top:8px;"></div>
                    <div class="input-group" style="margin-top:8px;">
                        <label for="quick-reps">Reps</label>
                        <input type="number" id="quick-reps" min="1" max="50" required placeholder="e.g., 10" value="10">
                    </div>
                    <button class="btn" type="submit" style="margin-top:16px;width:100%;">Save Quick Log</button>
                    <button class="btn btn-secondary" type="button" style="margin-top:8px;width:100%;" onclick="closeQuickLogModal()">Cancel</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Floating Quick Log Button removed in favor of action bar -->
    <div class="container">
        <header>
            <div style="display:flex;align-items:center;gap:12px;">
                <img src="icons/icon-192.png" alt="App Icon" style="width:36px;height:36px;border-radius:8px;object-fit:cover;flex:0 0 auto;" />
                <h1 style="margin:0;">Fitness Dashboard</h1>
            </div>
        </header>
        <!-- Bottom Tab Bar Navigation -->
        <nav class="tab-bar">
            <button class="tab-bar-btn" id="tab-workouts" aria-label="Workouts">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="7" width="3" height="10" rx="1"/>
                    <rect x="19" y="7" width="3" height="10" rx="1"/>
                    <rect x="7" y="9" width="10" height="6" rx="1"/>
                    <line x1="5" y1="12" x2="7" y2="12"/>
                    <line x1="17" y1="12" x2="19" y2="12"/>
                </svg>
                Workouts
            </button>
            <button class="tab-bar-btn" id="tab-quick" aria-label="Quick Log">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 2L3 14h7v8l8-12h-7V2z"/>
                </svg>
                Quick
            </button>
            <button class="tab-bar-btn" id="tab-create" aria-label="Create Plan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="4"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                    <line x1="12" y1="14" x2="12" y2="18"/>
                    <line x1="10" y1="16" x2="14" y2="16"/>
                </svg>
                Create
            </button>
            <button class="tab-bar-btn" id="tab-stats" aria-label="Stats">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                    <line x1="3" y1="20" x2="21" y2="20"/>
                    <rect x="5" y="12" width="3" height="8" rx="1"/>
                    <rect x="11" y="8" width="3" height="12" rx="1"/>
                    <rect x="17" y="4" width="3" height="16" rx="1"/>
                </svg>
                Stats
            </button>
        </nav>
        <div id="main-dashboard">
            <section id="workout-section" class="section">
                <div id="welcome-message" style="margin-bottom:32px;">
                    <h2 id="welcome-title">Welcome to Your Lifting Program!</h2>
                    <p id="welcome-motivation" style="font-size:1.15em;color:var(--primary);margin-bottom:8px;"></p>
                </div>
                <h2 style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                                        <span>Workout Plan</span>
                                        <span style="display:flex;gap:8px;">
                                                <button id="qr-share-btn" class="btn btn-secondary" type="button" title="Show plan as QR">
                                                                                <span style="vertical-align:middle;display:inline-block;width:1.6em;height:1.6em;">
                                                                                    <!-- QR code SVG icon -->
                                                                                    <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                                                                        <rect x="2" y="2" width="6" height="6" rx="1.5"/>
                                                                                        <rect x="16" y="2" width="6" height="6" rx="1.5"/>
                                                                                        <rect x="2" y="16" width="6" height="6" rx="1.5"/>
                                                                                        <rect x="10" y="10" width="4" height="4" rx="1"/>
                                                                                        <rect x="16" y="16" width="2" height="2" rx="0.5"/>
                                                                                        <rect x="20" y="20" width="2" height="2" rx="0.5"/>
                                                                                    </svg>
                                                                                </span>
                                                </button>
                                                <button id="qr-scan-btn" class="btn" type="button" title="Scan a plan QR">
                                                                                <span style="vertical-align:middle;display:inline-block;width:1.6em;height:1.6em;">
                                                                                    <!-- Camera/Scan SVG icon -->
                                                                                    <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                                                                        <rect x="4" y="7" width="16" height="12" rx="2"/>
                                                                                        <circle cx="12" cy="13" r="3"/>
                                                                                        <rect x="9" y="3" width="6" height="3" rx="1"/>
                                                                                    </svg>
                                                                                </span>
                                                </button>
                                        </span>
                </h2>
                <main>
                </main>
            </section>
        </div>
        <!-- QR Share Modal -->
    <div id="qr-share-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2003;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:24px;border-radius:12px;max-width:420px;width:90vw;margin:auto;box-shadow:0 4px 24px rgba(44,62,80,0.12);text-align:center;">
                <h2 style="margin-top:0;color:var(--primary);">Scan This QR</h2>
                <p style="color:var(--text-muted);margin:0 0 12px 0;">Shares your current workout plan offline.</p>
                <div id="qr-share-container" style="display:flex;align-items:center;justify-content:center;min-height:260px;"></div>
                <div style="margin-top:16px;display:flex;gap:8px;justify-content:center;">
                    <button class="btn" id="qr-share-close">Close</button>
                    <button class="btn btn-secondary" id="qr-copy-string">Copy String</button>
                </div>
            </div>
        </div>
        <!-- QR Scan Modal -->
    <div id="qr-scan-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2003;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:24px;border-radius:12px;max-width:480px;width:92vw;margin:auto;box-shadow:0 4px 24px rgba(44,62,80,0.12);">
                <h2 style="margin-top:0;color:var(--primary);">Scan Plan QR</h2>
                <div style="display:flex;flex-direction:column;gap:12px;align-items:center;">
                    <video id="qr-video" autoplay playsinline style="width:100%;max-height:300px;background:#000;border-radius:8px;"></video>
                    <canvas id="qr-canvas" style="display:none;"></canvas>
                    <div id="qr-scan-status" style="color:var(--text-muted);font-size:0.95em;">Initializing camera…</div>
                    <div style="display:flex;gap:8px;justify-content:center;">
                        <button class="btn" id="qr-scan-close">Close</button>
                        <button class="btn btn-secondary" id="qr-scan-retry">Retry</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="main-pastworkouts" style="display:none;">
            <section class="section stats-accordion">
                <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <h2 style="margin:0;">Stats</h2>
                    <button class="btn" style="background:#ef4444;color:#fff;" onclick="clearAllData()">Clear All Data & Restart</button>
                </div>

                <details open id="measurements-section">
                    <summary>Track Your Measurements</summary>
                    <div class="section-body">
                        <div class="input-grid">
                            <div class="input-group">
                                <label for="body-weight">Body Weight (kg)</label>
                                <input type="number" id="body-weight" placeholder="e.g., 95.5" inputmode="decimal" step="0.1" min="0">
                            </div>
                            <div class="input-group">
                                <label for="chest-measure">Chest (cm)</label>
                                <input type="number" id="chest-measure" placeholder="e.g., 110" inputmode="decimal" step="0.1" min="0">
                            </div>
                            <div class="input-group">
                                <label for="waist-measure">Waist (cm)</label>
                                <input type="number" id="waist-measure" placeholder="e.g., 90" inputmode="decimal" step="0.1" min="0">
                            </div>
                            <div class="input-group">
                                <label for="hips-measure">Hips (cm)</label>
                                <input type="number" id="hips-measure" placeholder="e.g., 105" inputmode="decimal" step="0.1" min="0">
                            </div>
                        </div>
                                                <button class="btn" style="width:100%;margin-top:16px;display:flex;align-items:center;justify-content:center;" onclick="saveMeasurements()" title="Save Today's Measurements">
                                                    <span style="display:inline-block;width:1.7em;height:1.7em;">
                                                        <!-- Save/Checkmark SVG icon -->
                                                        <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                                            <path d="M5 13l4 4L19 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                                            <rect x="3" y="3" width="18" height="18" rx="4" fill="currentColor" opacity="0.2"/>
                                                        </svg>
                                                    </span>
                                                </button>
                    </div>
                </details>

                <details open id="dashboard-section">
                    <summary>Body Composition</summary>
                    <div class="section-body">
                        <div class="chart-container">
                            <canvas id="bodyCompChart"></canvas>
                        </div>
                    </div>
                </details>

                <details id="exercise-charts-section">
                    <summary>Exercise Progress</summary>
                    <div class="section-body">
                        <div id="exercise-charts-container"></div>
                    </div>
                </details>

                <details id="past-workouts-section">
                    <summary>Past Workouts</summary>
                    <div class="section-body">
                        <div id="past-workouts-table" class="table-scroll"></div>
                    </div>
                </details>

                <details id="weekly-strength-section">
                    <summary>Weekly Strength Volume</summary>
                    <div class="section-body">
                        <div id="weekly-strength-volume-table" class="table-scroll"></div>
                    </div>
                </details>

                <details id="measurements-history-section">
                    <summary>Measurements & Body Weight History</summary>
                    <div class="section-body">
                        <div id="measurements-history-table" class="table-scroll"></div>
                    </div>
                </details>
            </section>
        </div>
    </div>
<script>
// What's New Modal Logic
const WHATS_NEW_VERSION = 'v2';
function showWhatsNewModal() {
    const modal = document.getElementById('whats-new-modal');
    if (modal) modal.style.display = 'flex';
}
function closeWhatsNewModal() {
    const modal = document.getElementById('whats-new-modal');
    if (modal) modal.style.display = 'none';
    localStorage.setItem('whatsNewDismissed', WHATS_NEW_VERSION);
}
window.addEventListener('DOMContentLoaded', function() {
    // Load external exercise dataset in background and refresh related UI
    loadExternalExerciseLibrary().then(loaded => {
        if (!loaded) return;
        try {
            // Refresh recommended plans (pools), and any open picker
            renderRecommendedPlans();
            // If picker open, rerender its filters and list
            const picker = document.getElementById('exercise-picker-modal');
            if (picker && picker.style.display === 'flex') {
                const filter = document.getElementById('muscle-filter');
                const muscles = Array.from(new Set(EXERCISE_LIBRARY.map(ex => ex.muscle))).sort();
                filter.innerHTML = '<option value="">All</option>' + muscles.map(m => `<option value="${m}">${m}</option>`).join('');
                resetExerciseListLimit();
                renderExerciseList(document.getElementById('exercise-search').value || '');
            }
        } catch (e) { console.warn('Post-load refresh error', e); }
    });
    // Show loading indicator briefly if dataset is being fetched
    const picker = document.getElementById('exercise-picker-modal');
    if (picker) {
        const list = document.getElementById('exercise-list');
        if (list) list.innerHTML = '<p style="color:var(--text-muted);">Loading exercise data…</p>';
    }
    if (localStorage.getItem('whatsNewDismissed') !== WHATS_NEW_VERSION) {
        setTimeout(showWhatsNewModal, 600);
    }
    const closeBtn = document.getElementById('whats-new-close');
    if (closeBtn) closeBtn.onclick = closeWhatsNewModal;
});
console.log('Lifting Tracker script started');
// --- Exercise Picker Modal Logic ---
// Fallback inline library; will be expanded by external dataset loader.
let EXERCISE_LIBRARY = [
    // Chest
    { name: 'Bench Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=gRVjAtPip0Y' },
    { name: 'Incline Bench Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=SrqOu55lrYU' },
    { name: 'Decline Bench Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=YQm6p6VQK6g' },
    { name: 'Dumbbell Fly', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=eozdVDA78K0' },
    { name: 'Push-Up', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=_l3ySVKYVJ8' },
    { name: 'Chest Dip', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=2z8JmcrW-As' },
    { name: 'Cable Crossover', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=taI4XduLpTk' },
    { name: 'Machine Chest Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=YQm6p6VQK6g' },
    { name: 'Pec Deck', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=YQm6p6VQK6g' },
    { name: 'Single Arm Chest Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=gRVjAtPip0Y' },
    { name: 'Isometric Chest Squeeze', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=YQm6p6VQK6g' },
    { name: 'Medicine Ball Chest Pass', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=YQm6p6VQK6g' },
    // Back
    { name: 'Pull-Up', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=eGo4IYlbE5g' },
    { name: 'Chin-Up', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=b-ztMQD1vwY' },
    { name: 'Lat Pulldown', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=CAwf7n6Luuc' },
    { name: 'Bent Over Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=vT2GjY_Umpw' },
    { name: 'Seated Cable Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=HJSVR_67OlM' },
    { name: 'T-Bar Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=8QZpG2s3yOI' },
    { name: 'Single Arm Dumbbell Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=pYcpY20QaE8' },
    { name: 'Inverted Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=F3QY5vMz_6I' },
    { name: 'Deadlift', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=ytGaGIn3SjE' },
    { name: 'Rack Pull', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=6YqjE1o0l9A' },
    { name: 'Good Morning', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=GqgkA1j4C9c' },
    { name: 'Hyperextension', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=1qj7M1LnJV8' },
    // Shoulders
    { name: 'Overhead Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=2yjwXTZQDDI' },
    { name: 'Arnold Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=6Z15_WdXmVw' },
    { name: 'Lateral Raise', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=3VcKaXpzqRo' },
    { name: 'Front Raise', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=-t7fuZ0KhDA' },
    { name: 'Rear Delt Fly', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=6yQ4Fq1QbTg' },
    { name: 'Face Pull', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=rep-qVOkqgk' },
    { name: 'Upright Row', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=8QZpG2s3yOI' },
    { name: 'Push Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=iaBVSJm78ko' },
    { name: 'Seated Dumbbell Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=B-aVuyhvLHU' },
    { name: 'Machine Shoulder Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=2yjwXTZQDDI' },
    { name: 'Cable Lateral Raise', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=3VcKaXpzqRo' },
    { name: 'Plate Raise', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=-t7fuZ0KhDA' },
    // Arms
    { name: 'Barbell Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=kwG2ipFRgfo' },
    { name: 'Hammer Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=zC3nLlEvin4' },
    { name: 'Preacher Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=6hEn6g8g6mY' },
    { name: 'Concentration Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QF0BQS2W80k' },
    { name: 'Cable Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=6hEn6g8g6mY' },
    { name: 'Triceps Pushdown', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=2-LAMcpzODU' },
    { name: 'Overhead Triceps Extension', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=2-LAMcpzODU' },
    { name: 'Skullcrusher', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=d_KZxkY_0cM' },
    { name: 'Dips', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=2z8JmcrW-As' },
    { name: 'Close Grip Bench Press', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=YQm6p6VQK6g' },
    { name: 'Kickback', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=6hEn6g8g6mY' },
    { name: 'Reverse Grip Triceps Pushdown', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=2-LAMcpzODU' },
    // Legs
    { name: 'Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=Dy28eq2PjcM' },
    { name: 'Front Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=t2b8Udqml-Y' },
    { name: 'Bulgarian Split Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=2C-uNgKwPLE' },
    { name: 'Leg Press', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=IZxyjW7MPJQ' },
    { name: 'Lunge', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Step-Up', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=dQqApCGd5Ss' },
    { name: 'Leg Extension', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=8QZpG2s3yOI' },
    { name: 'Leg Curl', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=1Tq3QdYUuHs' },
    { name: 'Calf Raise', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=YMmgqO8Jo-k' },
    { name: 'Seated Calf Raise', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=YMmgqO8Jo-k' },
    { name: 'Glute Bridge', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=m2Zx-57cS2E' },
    { name: 'Hip Thrust', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=LM8XHLYJoYs' },
    // Core
    { name: 'Plank', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=pSHjTRCQxIw' },
    { name: 'Crunch', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=Xyd_fa5zoEU' },
    { name: 'Russian Twist', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=wkD8rjkodUI' },
    { name: 'Leg Raise', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'Hanging Knee Raise', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'Cable Crunch', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'Ab Wheel Rollout', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'Mountain Climber', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=nmwgirgXLYM' },
    { name: 'Side Plank', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'V-Up', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'Flutter Kick', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    { name: 'Toe Touch', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=JB2oyawG9KI' },
    // Cardio
    { name: 'Running', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Cycling', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Rowing', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Jump Rope', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Stair Climber', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Swimming', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'HIIT', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sled Push', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Battle Rope', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Box Jump', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Burpee', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Farmer’s Walk', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    // Mobility & Rehab
    { name: 'Foam Roll', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Band Pull Apart', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Cat Cow', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Bird Dog', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'World’s Greatest Stretch', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: '90/90 Hip Stretch', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Couch Stretch', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Scapular Wall Slide', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Ankle Mobility Drill', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Shoulder Dislocate', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Hip Flexor Stretch', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Thoracic Extension', muscle: 'Mobility', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    // Specialty
    { name: 'Turkish Get-Up', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=0bWRGgR5wqg' },
    { name: 'Kettlebell Swing', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=6u6Qp7QSbJQ' },
    { name: 'Landmine Press', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sissy Squat', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Jefferson Curl', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Zercher Squat', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Suitcase Deadlift', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Single Leg RDL', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Cossack Squat', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Pistol Squat', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Dragon Flag', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sots Press', muscle: 'Specialty', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    // Glutes
    { name: 'Donkey Kick', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Fire Hydrant', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Cable Kickback', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sumo Squat', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Curtsy Lunge', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Step Down', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Glute March', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Frog Pump', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Banded Walk', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Hip Abduction', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Clamshell', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Monster Walk', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    // Full Body
    { name: 'Clean', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Snatch', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Thruster', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Man Maker', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Bear Complex', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Burpee Pull-Up', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Devil Press', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Wall Ball', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Medicine Ball Slam', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Farmer’s Carry', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sandbag Clean', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Tire Flip', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    // Add more to reach 150
    { name: 'Reverse Lunge', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Goblet Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Split Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Walking Lunge', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Step Up', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Romanian Deadlift', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sumo Deadlift', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Pendlay Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Wide Grip Pull-Up', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Close Grip Pull-Up', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Reverse Fly', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Cable Face Pull', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Dumbbell Shoulder Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Barbell Shoulder Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Shrug', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Reverse Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'EZ Bar Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Spider Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Incline Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Cable Hammer Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'French Press', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Triceps Extension', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Diamond Push-Up', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Bench Dip', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Reverse Grip Bench Press', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Standing Calf Raise', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Donkey Calf Raise', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Lunge', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Calf Raise', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Deadlift', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Row', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Shrug', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Bench Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Incline Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Decline Press', muscle: 'Chest', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Shoulder Press', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Triceps Extension', muscle: 'Triceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Smith Machine Biceps Curl', muscle: 'Biceps', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    // Add more as needed to reach 150
    { name: 'Medicine Ball Slam', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Jumping Jack', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'High Knees', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Butt Kick', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sprint', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Agility Ladder Drill', muscle: 'Cardio', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Box Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Pause Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sumo Deadlift High Pull', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Power Clean', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Power Snatch', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Push Jerk', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Split Jerk', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Handstand Push-Up', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Handstand Hold', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Wall Walk', muscle: 'Shoulders', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Plank Up Down', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Superman', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Reverse Hyper', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Back Extension', muscle: 'Back', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Oblique Crunch', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Standing Oblique Crunch', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Windshield Wiper', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Hollow Hold', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'L-Sit', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Dragon Walk', muscle: 'Core', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Bear Crawl', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Crab Walk', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Sled Drag', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Carry', muscle: 'Full Body', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Step-Up', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Lunge', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Jump Squat', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Calf Raise', muscle: 'Legs', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Hip Thrust', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Glute Bridge', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Donkey Kick', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Fire Hydrant', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Clamshell', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' },
    { name: 'Weighted Monster Walk', muscle: 'Glutes', demo: 'https://www.youtube.com/watch?v=QOVaHwm-Q6U' }
];

// External dataset loader: fetches and caches a 500+ exercise list
const EXTERNAL_EXERCISE_URL = 'https://raw.githubusercontent.com/exercemus/exercises/minified/minified-exercises.json';
const EXTERNAL_EXERCISE_CACHE_KEY = 'exerciseLibraryV1';
const EXTERNAL_EXERCISE_CACHE_TS = 'exerciseLibraryV1_ts';
const EXTERNAL_EXERCISE_TTL_MS = 1000 * 60 * 60 * 24 * 14; // 14 days

function mapPrimaryToCategory(primary, category) {
    const p = (primary || '').toLowerCase();
    const cat = (category || '').toLowerCase();
    if (cat === 'cardio') return 'Cardio';
    if (cat === 'stretching') return 'Mobility';
    if (cat === 'olympic weightlifting' || cat === 'crossfit') return 'Full Body';
    if (cat === 'strongman' || cat === 'plyometrics') return 'Specialty';
    if (['chest','serratus anterior'].includes(p)) return 'Chest';
    if (['shoulders'].includes(p)) return 'Shoulders';
    if (['lats','middle back','lower back','traps','neck'].includes(p)) return 'Back';
    if (['biceps','forearms','brachialis'].includes(p)) return 'Biceps';
    if (['triceps'].includes(p)) return 'Triceps';
    if (['glutes'].includes(p)) return 'Glutes';
    if (['abs','obliques'].includes(p)) return 'Core';
    if (['quads','hamstrings','adductors','abductors','calves','soleus'].includes(p)) return 'Legs';
    return 'Specialty';
}

function normalizeExternalExercises(json) {
    try {
        const arr = Array.isArray(json?.exercises) ? json.exercises : [];
        const out = [];
        const seen = new Set();
        for (const ex of arr) {
            const name = (ex?.name || '').trim();
            if (!name || seen.has(name)) continue;
            const primary = Array.isArray(ex.primary_muscles) && ex.primary_muscles.length ? ex.primary_muscles[0] : '';
            const muscle = mapPrimaryToCategory(primary, ex.category);
            const demo = typeof ex.video === 'string' && ex.video.startsWith('http') ? ex.video : '';
            out.push({ name, muscle, demo });
            seen.add(name);
        }
        return out;
    } catch (e) {
        console.warn('Failed to normalize external exercises', e);
        return [];
    }
}

async function fetchExternalExerciseLibrary() {
    const ts = parseInt(localStorage.getItem(EXTERNAL_EXERCISE_CACHE_TS) || '0', 10) || 0;
    const cached = localStorage.getItem(EXTERNAL_EXERCISE_CACHE_KEY);
    const now = Date.now();
    if (cached && now - ts < EXTERNAL_EXERCISE_TTL_MS) {
        try {
            const parsed = JSON.parse(cached);
            if (Array.isArray(parsed) && parsed.length >= 400) return parsed;
        } catch {}
    }
    try {
        const resp = await fetch(EXTERNAL_EXERCISE_URL, { cache: 'no-cache' });
        if (!resp.ok) throw new Error('Network error: ' + resp.status);
        const json = await resp.json();
        const list = normalizeExternalExercises(json);
        if (list.length >= 400) {
            localStorage.setItem(EXTERNAL_EXERCISE_CACHE_KEY, JSON.stringify(list));
            localStorage.setItem(EXTERNAL_EXERCISE_CACHE_TS, String(Date.now()));
            return list;
        }
    } catch (e) {
        console.warn('External exercise fetch failed', e);
    }
    return [];
}

async function loadExternalExerciseLibrary() {
    const ext = await fetchExternalExerciseLibrary();
    if (!ext.length) return false;
    const byName = new Map();
    // Merge inline and external, external wins on duplicates
    [...EXERCISE_LIBRARY, ...ext].forEach(ex => {
        if (ex && ex.name) byName.set(ex.name, { name: ex.name, muscle: ex.muscle, demo: ex.demo || '' });
    });
    EXERCISE_LIBRARY = Array.from(byName.values());
    return true;
}
let exercisePickerCallback = null;
function openExercisePickerModal(onSelect) {
    exercisePickerCallback = onSelect;
    document.getElementById('exercise-picker-modal').style.display = 'flex';
    document.getElementById('exercise-search').value = '';
    // Populate muscle group filter
    const filter = document.getElementById('muscle-filter');
    const muscles = Array.from(new Set(EXERCISE_LIBRARY.map(ex => ex.muscle))).sort();
    filter.innerHTML = '<option value="">All</option>' + muscles.map(m => `<option value="${m}">${m}</option>`).join('');
    resetExerciseListLimit();
    renderExerciseList('', '');
}

function closeExercisePickerModal() {
    document.getElementById('exercise-picker-modal').style.display = 'none';
    exercisePickerCallback = null;
}

// Virtualized exercise list parameters
let EXERCISE_RENDER_LIMIT = 50; // kept for compatibility
const VIRT_ITEM_HEIGHT = 56; // px per item
const VIRT_BUFFER = 6; // items above/below viewport to render
let CURRENT_FILTERED_EXERCISES = [];

function resetExerciseListLimit() { EXERCISE_RENDER_LIMIT = 50; }

function setupVirtualExerciseList() {
    const listDiv = document.getElementById('exercise-list');
    if (!listDiv || listDiv._virtInitialized) return;
    listDiv.style.position = 'relative';
    listDiv.style.willChange = 'transform';

    // Handle clicks on the Select buttons using delegation (avoids inline onclick escaping)
    listDiv.addEventListener('click', (ev) => {
        const btn = ev.target.closest && ev.target.closest('[data-action="select-exercise"]');
        if (btn) {
            const name = btn.dataset && btn.dataset.name;
            if (name) selectExerciseFromPicker(name);
        }
    });

    // Re-render visible window on scroll (throttled via requestAnimationFrame)
    let raf = null;
    listDiv.addEventListener('scroll', () => {
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(() => {
            // keep current filter text
            const txt = document.getElementById('exercise-search')?.value || '';
            renderExerciseList(txt);
        });
    });
    listDiv._virtInitialized = true;
}

function renderExerciseList(filter) {
    const listDiv = document.getElementById('exercise-list');
    if (!listDiv) return;
    const searchValue = typeof filter === 'string' ? filter : '';
    const muscleFilter = document.getElementById('muscle-filter') ? document.getElementById('muscle-filter').value : '';
    const filterLower = searchValue.toLowerCase();
    let filtered = EXERCISE_LIBRARY.filter(ex =>
        (ex.name.toLowerCase().includes(filterLower) || ex.muscle.toLowerCase().includes(filterLower)) &&
        (muscleFilter ? ex.muscle === muscleFilter : true)
    );
    if (searchValue.length === 0 && !muscleFilter) filtered = EXERCISE_LIBRARY.slice();

    CURRENT_FILTERED_EXERCISES = filtered;
    const total = filtered.length;

    // If very small, render simple list
    if (total === 0) {
        listDiv.innerHTML = '<p style="color:var(--text-muted);padding:8px;">No exercises found.</p>';
        return;
    }

    const itemH = VIRT_ITEM_HEIGHT;
    const viewH = listDiv.clientHeight || 320;
    const itemsPerView = Math.ceil(viewH / itemH);
    const scrollTop = listDiv.scrollTop || 0;
    const startIndex = Math.max(0, Math.floor(scrollTop / itemH) - VIRT_BUFFER);
    const endIndex = Math.min(total, startIndex + itemsPerView + VIRT_BUFFER * 2);

    const topSpacer = startIndex * itemH;
    const bottomSpacer = Math.max(0, (total - endIndex) * itemH);

    // Build minimal DOM via innerHTML (keeps code footprint small)
    let html = '';
    html += `<div style="height:${topSpacer}px"></div>`;
    for (let i = startIndex; i < endIndex; i++) {
        const ex = filtered[i];
        const nameAttr = (ex.name || '').replace(/"/g, '&quot;');
        html += `
            <div style="height:${itemH}px;display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #E2E8F0;">
                <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">
                    <strong style="display:block;">${ex.name}</strong>
                    <span style="color:#888;font-size:0.9em">(${ex.muscle})</span>
                </div>
                <button class="btn" data-action="select-exercise" data-name="${nameAttr}" style="padding:6px 12px;font-size:0.95em;min-width:0;">Select</button>
            </div>
        `;
    }
    html += `<div style="height:${bottomSpacer}px"></div>`;
    listDiv.innerHTML = html;
}

function selectExerciseFromPicker(name) {
    if (exercisePickerCallback) exercisePickerCallback(name);
    closeExercisePickerModal();
}

document.addEventListener('DOMContentLoaded', function() {
    // Debounced search for large libraries
    let t = null;
    const exerciseSearch = document.getElementById('exercise-search');
    const muscleFilterEl = document.getElementById('muscle-filter');
    if (exerciseSearch) {
        exerciseSearch.addEventListener('input', function(e) {
            const val = e.target.value;
            if (t) clearTimeout(t);
            t = setTimeout(() => { resetExerciseListLimit(); renderExerciseList(val); }, 200);
        });
    }
    if (muscleFilterEl) {
        muscleFilterEl.addEventListener('change', function() {
            resetExerciseListLimit();
            renderExerciseList(document.getElementById('exercise-search').value);
        });
    }
    // Initialize virtualized list when DOM ready
    setupVirtualExerciseList();
    // Initial render
    setTimeout(() => renderExerciseList(document.getElementById('exercise-search')?.value || ''), 0);
    document.getElementById('exercise-picker-cancel').addEventListener('click', closeExercisePickerModal);
});
function clearAllData() {
    localStorage.removeItem('userDetails');
    localStorage.removeItem('bodyTrackerData');
    localStorage.removeItem('workoutTrackerData');
    location.reload();
}
const MOTIVATION_MESSAGES = [
    "Every rep brings you closer to your goal.",
    "Progress is progress, no matter how small.",
    "Consistency beats intensity—show up for yourself!",
    "Strong mind, strong body—let's get it!",
    "You are stronger than you think.",
    "The only bad workout is the one you didn’t do.",
    "Push past your limits today.",
    "Your future self will thank you.",
    "Small steps lead to big changes.",
    "Sweat is just fat crying.",
    "Champions are made in the gym.",
    "Don’t wish for it—work for it!",
    "Strength grows in the moments you think you can’t go on but you keep going.",
    "No excuses, just results.",
    "You’re one workout away from a good mood.",
    "The pain you feel today will be the strength you feel tomorrow.",
    "Your only competition is yourself.",
    "Success starts with self-discipline.",
    "You don’t have to be extreme, just consistent.",
    "Make yourself proud today.",
    "The best project you’ll ever work on is you.",
    "Don’t stop when you’re tired—stop when you’re done.",
    "It’s not about being the best, it’s about being better than you were yesterday.",
    "You’re building more than muscle—you’re building character.",
    "The only way to finish is to start.",
    "Your body can stand almost anything. It’s your mind you have to convince.",
    "Push yourself, because no one else is going to do it for you.",
    "Great things never come from comfort zones.",
    "Don’t count the days—make the days count.",
    "You’re not just working out, you’re working on yourself.",
    "If it doesn’t challenge you, it won’t change you.",
    "You’re capable of amazing things.",
    "The difference between try and triumph is a little ‘umph’.",
    "You didn’t come this far to only come this far.",
    "Your only limit is you.",
    "Success is the sum of small efforts repeated day in and day out.",
    "Don’t let yesterday take up too much of today.",
    "You are your only limit.",
    "The harder you work, the luckier you get.",
    "You’re not just lifting weights, you’re lifting yourself up.",
    "The secret to getting ahead is getting started.",
    "You’re stronger with every set.",
    "Your journey is your strength.",
    "You’re here to be awesome.",
    "You’re unstoppable when you believe in yourself.",
    "You’re not just training your body, you’re training your mind.",
    "You’re one step closer to your goal.",
    "You’re making progress every day.",
    "You’re building a better you.",
    "You’re crushing it!",
    "You’re a warrior—keep fighting.",
    "You’re rewriting your story with every workout.",
    "You’re investing in yourself.",
    "You’re proving to yourself what you’re capable of.",
    "You’re inspiring others by showing up.",
    "You’re making yourself proud.",
    "You’re unstoppable.",
    "You’re a champion in the making.",
    "You’re stronger than your excuses.",
    "You’re here to win.",
    "You’re the author of your own success.",
    "You’re turning dreams into reality.",
    "You’re making it happen!",
    "You’re the architect of your own destiny.",
    "Every day is a new opportunity to improve.",
    "Your effort today shapes your tomorrow.",
    "You’re building habits that last a lifetime.",
    "Success is earned, not given.",
    "You’re one step closer to greatness.",
    "Your journey is unique—embrace it.",
    "You’re stronger with every challenge you overcome.",
    "You’re unstoppable when you set your mind to it.",
    "You’re making progress, even if it’s slow.",
    "You’re the hero of your own story.",
    "You’re creating a legacy of strength.",
    "You’re proving that hard work pays off.",
    "You’re inspiring yourself and others.",
    "You’re making every day count.",
    "You’re building resilience with every workout.",
    "You’re turning obstacles into opportunities.",
    "You’re mastering your mindset.",
    "You’re pushing past your comfort zone.",
    "You’re investing in your health and happiness.",
    "You’re showing up for yourself, every day.",
    "You’re making your dreams a reality.",
    "You’re unstoppable when you believe in your potential.",
    "You’re creating a future you’ll be proud of.",
    "You’re building strength inside and out.",
    "You’re making progress, one step at a time.",
    "You’re proving that you’re capable of anything.",
    "You’re making your mark on the world.",
    "You’re building a foundation for success.",
    "You’re showing the world what you’re made of.",
    "You’re making every rep count.",
    "You’re unstoppable when you set your sights high.",
    "You’re creating a life you love.",
    "You’re building momentum with every workout.",
    "You’re proving that persistence pays off.",
    "You’re making yourself proud, every day.",
    "You’re unstoppable when you refuse to quit.",
    "You’re building a better future for yourself.",
    "You’re making progress, even when it’s tough.",
    "You’re proving that you’re stronger than you think.",
    "You’re making every moment count.",
    "You’re unstoppable when you chase your dreams.",
    "You’re building a legacy of greatness.",
    "You’re making progress, no matter what.",
    "You’re proving that you’re a force to be reckoned with.",
    "You’re making every day a victory.",
    "You’re unstoppable when you never give up.",
    "You’re building a life of strength and purpose.",
    "You’re making progress, one day at a time.",
    "You’re proving that you’re unstoppable.",
    "You’re making every workout count.",
    "You’re unstoppable when you believe in yourself.",
    "You’re building a future full of possibilities."
];

// Utility to create safe ID fragments from arbitrary labels (e.g., day names)
function slugifyId(str) {
    return String(str || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
}

// --- Quick Log Modal Logic ---
function openQuickLogModal() {
    const modal = document.getElementById('quick-log-modal');
    modal.style.display = 'flex';
    const input = document.getElementById('quick-exercise-input');
    const chooseBtn = document.getElementById('quick-choose-exercise-btn');
    const setsEl = document.getElementById('quick-sets');
    const repsEl = document.getElementById('quick-reps');
    const setContainer = document.getElementById('quick-set-inputs-container');
    const suggestionEl = document.getElementById('quick-suggestion');

    // Restore saved state if present
    const saved = localStorage.getItem('quickLogDraft');
    let draft = saved ? JSON.parse(saved) : {};
    input.value = draft.exercise || '';
    setsEl.value = draft.sets || 3;
    repsEl.value = draft.reps || 10;

    function buildQuickSetInputs() {
        setContainer.innerHTML = '';
        const sets = Math.max(1, Math.min(10, parseInt(setsEl.value) || 1));
        // Try to pull last session max for suggestion and prefill
        const exName = (input.value || '').trim();
        let lastMax = null;
        if (exName && workoutData[exName] && workoutData[exName].length > 0) {
            const last = workoutData[exName][workoutData[exName].length - 1];
            const weights = (last.weights && last.weights.length ? last.weights : (last.values || [])).filter(v => typeof v === 'number' && v > 0);
            if (weights.length) lastMax = Math.max(...weights);
        }
        suggestionEl.textContent = lastMax != null ? `Suggestion: Last max was ${lastMax}. Try for ${lastMax + 2.5}.` : 'Log a workout to get suggestions.';
        for (let i = 0; i < sets; i++) {
            const div = document.createElement('div');
            div.className = 'input-group';
            const id = `quick-set-${i+1}`;
            let value = '';
            if (draft.weights && typeof draft.weights[i] !== 'undefined') value = draft.weights[i];
            else if (lastMax != null) value = lastMax;
            div.innerHTML = `
                <label for="${id}">Set ${i+1} Weight</label>
                <input type="number" id="${id}" min="0" step="0.5" placeholder="kg/lbs" value="${value}">
            `;
            setContainer.appendChild(div);
        }
    }

    function saveDraft() {
        const weights = [];
        for (let i = 0; i < Math.max(1, Math.min(10, parseInt(setsEl.value) || 1)); i++) {
            const v = document.getElementById(`quick-set-${i+1}`)?.value;
            weights.push(v);
        }
        localStorage.setItem('quickLogDraft', JSON.stringify({
            exercise: input.value,
            sets: setsEl.value,
            reps: repsEl.value,
            weights
        }));
    }

    function openPicker() {
        openExercisePickerModal(function(name){
            input.value = name;
            saveDraft();
            buildQuickSetInputs();
        });
    }

    // Wire once per open (idempotent listeners)
    input.onclick = openPicker;
    chooseBtn.onclick = openPicker;
    setsEl.oninput = function() { buildQuickSetInputs(); saveDraft(); };
    repsEl.oninput = saveDraft;
    input.oninput = function() { saveDraft(); buildQuickSetInputs(); };
    setContainer.oninput = saveDraft;
    // Initial render
    buildQuickSetInputs();
    saveDraft();
}

function closeQuickLogModal() {
    document.getElementById('quick-log-modal').style.display = 'none';
    const form = document.getElementById('quick-log-form');
    if (form) form.reset();
    const setContainer = document.getElementById('quick-set-inputs-container');
    if (setContainer) setContainer.innerHTML = '';
    const suggestionEl = document.getElementById('quick-suggestion');
    if (suggestionEl) suggestionEl.textContent = '';
    // Clear draft ONLY on cancel
    localStorage.removeItem('quickLogDraft');
}

window.addEventListener('DOMContentLoaded', function() {
    document.getElementById('quick-log-form').onsubmit = function(e) {
        e.preventDefault();
        const name = (document.getElementById('quick-exercise-input').value || '').trim();
        const sets = Math.max(1, Math.min(10, parseInt(document.getElementById('quick-sets').value) || 0));
        const reps = Math.max(1, Math.min(50, parseInt(document.getElementById('quick-reps').value) || 0));
        if (!name || !sets || !reps) {
            alert('Please fill out exercise, sets and reps.');
            return;
        }
        const weights = [];
        for (let i = 0; i < sets; i++) {
            const v = parseFloat(document.getElementById(`quick-set-${i+1}`)?.value);
            weights.push(isNaN(v) ? 0 : v);
        }
        if (!workoutData[name]) workoutData[name] = [];
        workoutData[name].push({
            date: new Date().toISOString().split('T')[0],
            weights: weights,
            values: weights, // maintain compatibility with readers using `values`
            sets: sets,
            reps: reps
        });
        localStorage.setItem('workoutTrackerData', JSON.stringify(workoutData));
        alert('Quick log saved!');
        // Clear draft ONLY on save
        localStorage.removeItem('quickLogDraft');
        closeQuickLogModal();
        updateSuggestions();
        updateStrengthVolumeChart();
        renderExerciseProgressCharts();
        renderUserWorkoutPlan();
    };
});

let workoutPlan = JSON.parse(localStorage.getItem('workoutPlan')) || {};
// Edit Plan logic
window.editPlan = function(day) {
    console.log('editPlan called for day:', day);
    document.getElementById('create-plan-modal').style.display = 'flex';
    const form = document.getElementById('create-plan-form');
    form.reset();
    document.getElementById('plan-day').value = day;
    const container = document.getElementById('exercise-fields');
    container.innerHTML = '';
    const exercisesToEdit = workoutPlan[day];
    console.log('exercisesToEdit:', exercisesToEdit);
    if (Array.isArray(exercisesToEdit) && exercisesToEdit.length > 0) {
        exercisesToEdit.forEach((ex, idx) => {
                        console.log('Populating exercise:', ex);
                        const div = document.createElement('div');
                        div.className = 'exercise-block';
                        div.style.marginBottom = '12px';
                        div.innerHTML = `
                            <details style="border:1px solid #e2e8f0;border-radius:8px;padding:0 0 8px 0;background:#fafbfc;">
                                <summary style="display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none;">
                                    <span style="font-weight:700;" id="exercise-label-${idx}">${ex.name ? ex.name : `Exercise ${idx + 1}`}</span>
                                    <button type="button" class="btn btn-secondary" title="Remove Exercise" style="padding:2px 10px;font-size:1em;min-width:0;display:flex;align-items:center;justify-content:center;margin-left:auto;" onclick="this.parentElement.parentElement.remove();updatePlanSummary();event.stopPropagation();">
                                        <span style="display:inline-block;width:1.3em;height:1.3em;">
                                            <!-- Trash/Delete SVG icon -->
                                            <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                                <path d="M3 6h18v2H3V6zm2 3h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9zm3 2v8h2v-8H8zm4 0v8h2v-8h-2z"/>
                                            </svg>
                                        </span>
                                    </button>
                                </summary>
                                <div class="input-group" style="margin-bottom:8px;margin-top:8px;">
                                    <label>Exercise</label>
                                    <input type="text" name="exercise-${idx}" required placeholder="Select or type exercise..." style="background:#f3f4f6;cursor:pointer;" autocomplete="off" value="${ex.name}">
                                    <button type="button" class="btn btn-secondary" style="margin-top:4px;" id="choose-exercise-btn-${idx}">Choose</button>
                                </div>
                                <div class="input-group" style="margin-bottom:8px;">
                                    <label>Sets</label>
                                    <input type="number" name="sets-${idx}" min="1" max="10" value="${ex.sets}" required>
                                </div>
                                <div class="input-group" style="margin-bottom:8px;">
                                    <label>Reps</label>
                                    <input type="number" name="reps-${idx}" min="1" max="50" value="${ex.reps}" required>
                                </div>
                                <div class="input-group" style="margin-bottom:8px;">
                                    <label>Weight (optional)</label>
                                    <input type="number" name="weight-${idx}" min="0" step="0.5" value="${ex.weight ? ex.weight : ''}">
                                </div>
                            </details>
                        `;
                        setTimeout(() => {
                                const input = div.querySelector(`[name='exercise-${idx}']`);
                                const btn = div.querySelector(`#choose-exercise-btn-${idx}`);
                                const label = div.querySelector(`#exercise-label-${idx}`);
                                const details = div.querySelector('details');
                                function updateLabel() {
                                        label.textContent = input.value ? input.value : `Exercise ${idx + 1}`;
                                }
                                function openPicker() {
                                        openExercisePickerModal(function(name){
                                                input.value = name;
                                                updateLabel();
                                                updatePlanSummary();
                                        });
                                }
                                input.addEventListener('input', updateLabel);
                                input.onclick = openPicker;
                                btn.onclick = openPicker;
                                label.onclick = function() {
                                        if (details) details.open = true;
                                };
                                updateLabel();
                        }, 0);
                        container.appendChild(div);
        });
    } else {
        // If no exercises, add a blank field
        console.log('No exercises found for this day, adding blank field.');
        if (container.children.length === 0) {
            addExerciseField();
        }
    }
    updatePlanSummary();
}
// --- Create Workout Plan Modal Logic ---
function openCreatePlanModal() {
    document.getElementById('create-plan-modal').style.display = 'flex';
    document.getElementById('create-plan-form').reset();
    document.getElementById('exercise-fields').innerHTML = '';
    addExerciseField();
}

function closeCreatePlanModal() {
    document.getElementById('create-plan-modal').style.display = 'none';
}

// Helper to create exercise field block
function createExerciseField(idx) {
    const div = document.createElement('div');
        div.className = 'exercise-block';
        div.style.marginBottom = '12px';
        div.innerHTML = `
            <details open style="border:1px solid #e2e8f0;border-radius:8px;padding:0 0 8px 0;background:#fafbfc;">
                <summary style="display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;user-select:none;">
                    <span style="font-weight:700;" id="exercise-label-${idx}">Exercise ${idx + 1}</span>
                    <button type="button" class="btn btn-secondary" title="Remove Exercise" style="padding:2px 10px;font-size:1em;min-width:0;display:flex;align-items:center;justify-content:center;margin-left:auto;" onclick="this.parentElement.parentElement.remove();updatePlanSummary();event.stopPropagation();">
                        <span style="display:inline-block;width:1.3em;height:1.3em;">
                            <!-- Trash/Delete SVG icon -->
                            <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                <path d="M3 6h18v2H3V6zm2 3h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9zm3 2v8h2v-8H8zm4 0v8h2v-8h-2z"/>
                            </svg>
                        </span>
                    </button>
                </summary>
                <div class="input-group" style="margin-bottom:8px;margin-top:8px;">
                    <label>Exercise</label>
                    <input type="text" name="exercise-${idx}" required placeholder="Select or type exercise..." style="background:#f3f4f6;cursor:pointer;" autocomplete="off">
                    <button type="button" class="btn btn-secondary" style="margin-top:4px;" id="choose-exercise-btn-${idx}">Choose</button>
                </div>
                <div class="input-group" style="margin-bottom:8px;">
                    <label>Sets</label>
                    <input type="number" name="sets-${idx}" min="1" max="10" value="3" required>
                </div>
                <div class="input-group" style="margin-bottom:8px;">
                    <label>Reps</label>
                    <input type="number" name="reps-${idx}" min="1" max="50" value="10" required>
                </div>
                <div class="input-group" style="margin-bottom:8px;">
                    <label>Weight (optional)</label>
                    <input type="number" name="weight-${idx}" min="0" step="0.5">
                </div>
            </details>
        `;
    // Attach picker logic after element is added to DOM
    setTimeout(() => {
        const input = div.querySelector(`[name='exercise-${idx}']`);
        const btn = div.querySelector(`#choose-exercise-btn-${idx}`);
        const label = div.querySelector(`#exercise-label-${idx}`);
        const details = div.querySelector('details');
        function updateLabel() {
            label.textContent = input.value ? input.value : `Exercise ${idx + 1}`;
        }
        function openPicker() {
            openExercisePickerModal(function(name){
                input.value = name;
                updateLabel();
                updatePlanSummary();
            });
        }
        input.addEventListener('input', updateLabel);
        input.onclick = openPicker;
        btn.onclick = openPicker;
        label.onclick = function() { if (details) details.open = true; };
        updateLabel();
    }, 0);
    return div;
}

// Add exercise field logic
function addExerciseField() {
    const container = document.getElementById('exercise-fields');
    const idx = container.children.length;
    // Collapse all previous exercise blocks (details)
    for (let i = 0; i < idx; i++) {
        const block = container.children[i];
        if (block) {
            const details = block.querySelector('details');
            if (details) details.open = false;
        }
    }
    // Add and expand the new exercise block
    const newBlock = createExerciseField(idx);
    const details = newBlock.querySelector('details');
    if (details) details.open = true;
    container.appendChild(newBlock);
    updatePlanSummary();
}

// Update plan summary
function updatePlanSummary() {
    const container = document.getElementById('exercise-fields');
    const summaryDiv = document.getElementById('plan-summary');
    let html = '<strong>Planned Exercises:</strong><ul style="margin:8px 0 0 0;padding-left:18px;">';
    for (let i = 0; i < container.children.length; i++) {
        const block = container.children[i];
        // Get exercise name from input[type=text]
        const ex = block.querySelector(`input[name='exercise-${i}']`);
        const sets = block.querySelector(`input[name='sets-${i}']`);
        const reps = block.querySelector(`input[name='reps-${i}']`);
        const weight = block.querySelector(`input[name='weight-${i}']`);
        if (ex && sets && reps) {
            html += `<li>${ex.value}: ${sets.value} sets x ${reps.value} reps${weight.value ? ` @ ${weight.value}` : ''}</li>`;
        }
    }
    html += '</ul>';
    summaryDiv.innerHTML = html;
}

// Attach add exercise button logic
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('add-exercise-btn').onclick = addExerciseField;
    document.getElementById('exercise-fields').addEventListener('input', updatePlanSummary);
    addExerciseField(); // Start with one exercise
});

// Create Plan Modal Form Logic (multi-exercise, improved)
document.getElementById('create-plan-form').onsubmit = function(e) {
    e.preventDefault();
    const day = document.getElementById('plan-day').value.trim();
    const container = document.getElementById('exercise-fields');
    const exercises = [];
    for (let i = 0; i < container.children.length; i++) {
        const block = container.children[i];
        const ex = block.querySelector(`input[name='exercise-${i}']`).value.trim();
        const sets = parseInt(block.querySelector(`input[name='sets-${i}']`).value);
        const reps = parseInt(block.querySelector(`input[name='reps-${i}']`).value);
        const weight = parseFloat(block.querySelector(`input[name='weight-${i}']`).value) || null;
        if (ex && sets && reps) {
            exercises.push({ name: ex, sets, reps, weight });
        }
    }
    if (!day || exercises.length === 0) {
        alert('Please enter a day and at least one exercise.');
        return;
    }
    workoutPlan[day] = exercises;
    localStorage.setItem('workoutPlan', JSON.stringify(workoutPlan));
    closeCreatePlanModal();
    renderUserWorkoutPlan();
};

function renderUserWorkoutPlan() {
    console.log('renderUserWorkoutPlan called');
    const mainContainer = document.querySelector('#workout-section main');
    let planHTML = '';
    const hasPlan = workoutPlan && Object.keys(workoutPlan).length > 0;
    if (!hasPlan) {
                planHTML += `<p>No workout plan found. Click <span style="display:inline-block;vertical-align:middle;width:1.5em;height:1.5em;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="100%" height="100%" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="4"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <line x1="12" y1="14" x2="12" y2="18"/>
                        <line x1="10" y1="16" x2="14" y2="16"/>
                    </svg>
                </span> to create one!</p>`;
    }
    for (const day in workoutPlan) {
        const idPrefix = slugifyId(day);
        planHTML += `
            <details class="workout-day">
                <summary style="display:flex;align-items:center;gap:12px;">
                    <span>${day}</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                                                <button class="btn btn-secondary edit-plan-btn" type="button" data-day="${day}" title="Edit Plan" style="font-size:1em;padding:4px 10px;display:flex;align-items:center;justify-content:center;">
                                                    <span style="display:inline-block;width:1.4em;height:1.4em;">
                                                        <!-- Pencil/Edit SVG icon -->
                                                        <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                                            <path d="M3 17.25V21h3.75l11.06-11.06-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
                                                        </svg>
                                                    </span>
                                                </button>
                                                <button class="btn btn-secondary delete-plan-btn" type="button" data-day="${day}" title="Delete Plan" style="font-size:1em;padding:4px 10px;background:#ef4444;color:#fff;border-color:#ef4444;display:flex;align-items:center;justify-content:center;">
                                                    <span style="display:inline-block;width:1.4em;height:1.4em;">
                                                        <!-- Trash/Delete SVG icon -->
                                                        <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                                            <path d="M3 6h18v2H3V6zm2 3h14v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9zm3 2v8h2v-8H8zm4 0v8h2v-8h-2z"/>
                                                        </svg>
                                                    </span>
                                                </button>
                    </div>
                </summary>
                <div class="workout-content" id="workout-content-${idPrefix}">
                    ${workoutPlan[day].map((ex, idx) => {
                        let setInputs = '';
                        for (let s = 0; s < ex.sets; s++) {
                            setInputs += `
                                <div class="input-group">
                                    <label for="weight-input-${idPrefix}-${idx}-set${s}">Set ${s + 1} Weight</label>
                                    <input type="number" id="weight-input-${idPrefix}-${idx}-set${s}" class="set-weight-input" min="0" step="0.5" placeholder="kg/lbs">
                                </div>
                            `;
                        }
                        // Suggestion logic
                        let suggestion = '';
                        if (workoutData[ex.name] && workoutData[ex.name].length > 0) {
                            const lastSession = workoutData[ex.name][workoutData[ex.name].length - 1];
                            const validWeights = (lastSession.weights || []).filter(w => w > 0);
                            if (validWeights.length > 0) {
                                const maxWeight = Math.max(...validWeights);
                                const suggestedWeight = maxWeight + 2.5;
                                suggestion = `<p class='suggestion' style='color:var(--accent);margin-top:8px;'>Suggestion: Last max was ${maxWeight}. Try for ${suggestedWeight}.</p>`;
                            }
                        } else {
                            suggestion = `<p class='suggestion' style='color:var(--text-muted);margin-top:8px;'>Log a workout to get suggestions.</p>`;
                        }
                        return `
                            <div class="exercise-card" data-exercise-name="${ex.name}" data-day="${day}" data-idx="${idx}">
                                <h3>${ex.name}</h3>
                                <p><strong>Target:</strong> ${ex.sets} sets x ${ex.reps} reps${ex.weight ? ` @ ${ex.weight}` : ''}</p>
                                ${setInputs}
                                ${suggestion}
                            </div>
                        `;
                    }).join('')}
                    <button class="btn" type="button" onclick="saveWorkout('${day}')">Save Workout</button>
                </div>
            </details>
        `;
    }
    // Append Recommended Plans section after user-created days
    planHTML += `
        <details class="workout-day" id="recommended-plans">
            <summary>Recommended Plans</summary>
            <div class="workout-content" id="recommended-content"></div>
        </details>
    `;
    mainContainer.innerHTML = planHTML;
    console.log('Injected workout plan HTML:', planHTML);
    // Event delegation is handled globally; no per-button wiring needed here
    // Render recommended plans content
    setTimeout(renderRecommendedPlans, 0);
}

window.addEventListener('DOMContentLoaded', renderUserWorkoutPlan);

// Global delegated listeners for Edit/Delete inside <summary>, using capture
document.addEventListener('DOMContentLoaded', function() {
    if (!window._wiredPlanDelegation) {
        const handler = function(e) {
            const deleteBtn = e.target.closest && e.target.closest('.delete-plan-btn');
            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();
                const day = deleteBtn.getAttribute('data-day');
                if (typeof window.deletePlan === 'function') window.deletePlan(day);
                return;
            }
            const editBtn = e.target.closest && e.target.closest('.edit-plan-btn');
            if (editBtn) {
                e.preventDefault();
                e.stopPropagation();
                const day = editBtn.getAttribute('data-day');
                if (typeof window.editPlan === 'function') window.editPlan(day);
            }
        };
        document.addEventListener('click', handler, true);
        document.addEventListener('pointerdown', handler, true);
        window._wiredPlanDelegation = true;
    }
});

// Delete Plan handler
window.deletePlan = function(day) {
    if (!day) return;
    if (!workoutPlan || !workoutPlan[day]) {
        // Nothing to delete; re-render to be safe
        try { renderUserWorkoutPlan(); } catch {}
        return;
    }
    const confirmed = confirm(`Delete the workout plan for "${day}"? This cannot be undone.`);
    if (!confirmed) return;
    try {
        delete workoutPlan[day];
        localStorage.setItem('workoutPlan', JSON.stringify(workoutPlan));
        renderUserWorkoutPlan();
        alert('Plan deleted.');
    } catch (e) {
        console.error('Failed to delete plan', e);
        alert('Failed to delete plan.');
    }
}

let workoutData = {};
let bodyData = [];
let bodyCompChart, strengthVolumeChart;

// --- Recommended Plans v2 (20 variants/day, show 1 per session) ---
const RECOMMENDED_CONFIG = {
    'Monday': { title: 'Legs and Shoulders', groups: [{ muscle: 'Legs' }, { muscle: 'Shoulders' }] },
    'Tuesday': { title: 'Chest and Triceps', groups: [{ muscle: 'Chest' }, { muscle: 'Triceps' }] },
    'Thursday': { title: 'Back and Biceps', groups: [{ muscle: 'Back' }, { muscle: 'Biceps' }] },
    'Friday': { title: 'Core and Fitness', groups: [{ muscle: 'Core' }, { muscle: 'Cardio' }] }
};

function uniqueByName(list) {
    const seen = new Set();
    const out = [];
    list.forEach(x => { if (!seen.has(x.name)) { seen.add(x.name); out.push(x); } });
    return out;
}
function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
    return a;
}
function sample(list, k) {
    const a = shuffle(list);
    return a.slice(0, Math.min(k, a.length));
}
function getMusclePool(muscle) {
    return uniqueByName(EXERCISE_LIBRARY.filter(e => e.muscle === muscle));
}
function buildVariantsForDay(day, targetCount = 20) {
    const cfg = RECOMMENDED_CONFIG[day];
    if (!cfg) return [];
    const pools = cfg.groups.map(g => getMusclePool(g.muscle));
    const seenCombos = new Set();
    const variants = [];
    // Try to build up to targetCount distinct variants; fall back to fewer if pools are small
    let guard = 0;
    while (variants.length < targetCount && guard < targetCount * 20) {
        guard++;
        const groupSets = pools.map(pool => {
            const n = 3 + Math.floor(Math.random() * 2); // 3-4 per group
            return sample(pool, n).map(ex => ({ name: ex.name, sets: 3, reps: 10 }));
        });
        const combined = groupSets.flat();
        const sig = combined.map(x => x.name).sort().join('|');
        if (sig && !seenCombos.has(sig) && combined.length >= 6) {
            seenCombos.add(sig);
            variants.push(combined);
        }
        if (seenCombos.size >= 1000) break;
    }
    return variants;
}
const RECOMMENDED_VARIANTS_KEY = 'recommendedPlanVariantsV1';
function getRecommendedVariantSets() {
    try {
        const stored = JSON.parse(localStorage.getItem(RECOMMENDED_VARIANTS_KEY) || 'null');
        if (stored && stored.version === 1 && stored.sets) return stored.sets;
    } catch {}
    const sets = {};
    Object.keys(RECOMMENDED_CONFIG).forEach(day => {
        const variants = buildVariantsForDay(day, 20);
        sets[day] = variants.length ? variants : [];
    });
    localStorage.setItem(RECOMMENDED_VARIANTS_KEY, JSON.stringify({ version: 1, sets }));
    return sets;
}
const RECOMMENDED_PICK_KEY = 'recommendedPlanPickSession';
function getSessionVariantPicks(sets) {
    let picks = {};
    try { picks = JSON.parse(sessionStorage.getItem(RECOMMENDED_PICK_KEY) || '{}'); } catch {}
    let changed = false;
    Object.keys(RECOMMENDED_CONFIG).forEach(day => {
        const arr = sets[day] || [];
        if (!arr.length) return;
        if (!(day in picks)) { picks[day] = Math.floor(Math.random() * arr.length); changed = true; }
        picks[day] = Math.max(0, Math.min(picks[day], arr.length - 1));
    });
    if (changed) sessionStorage.setItem(RECOMMENDED_PICK_KEY, JSON.stringify(picks));
    return picks;
}
function renderRecommendedPlans() {
    const container = document.getElementById('recommended-content');
    if (!container) return;
    const sets = getRecommendedVariantSets();
    const picks = getSessionVariantPicks(sets);
    let html = '';
    Object.keys(RECOMMENDED_CONFIG).forEach(day => {
        const title = RECOMMENDED_CONFIG[day].title;
        const variants = sets[day] || [];
        if (!variants.length) return;
        const idx = picks[day] ?? 0;
        const shown = variants[idx] || [];
        html += `
            <div class="exercise-card">
                <h3 style="margin-bottom:4px;">${day} — ${title}</h3>
                <p style="margin:0 0 6px 0;color:var(--text-muted);">Fresh pick for today. Reopen app to see another.</p>
                <ul style="margin:8px 0 12px 16px;">
                    ${shown.map(ex => `<li>${ex.name}: ${ex.sets} x ${ex.reps}</li>`).join('')}
                </ul>
                                <button class="btn btn-secondary add-recommended-btn" type="button" data-day="${day}" title="Add This Day" style="padding:6px 10px;display:flex;align-items:center;justify-content:center;">
                                    <span style="display:inline-block;width:1.5em;height:1.5em;">
                                        <!-- Plus/Add SVG icon -->
                                        <svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%" aria-hidden="true">
                                            <rect x="11" y="4" width="2" height="16" rx="1"/>
                                            <rect x="4" y="11" width="16" height="2" rx="1"/>
                                        </svg>
                                    </span>
                                </button>
            </div>
        `;
    });
    container.innerHTML = html || '<p style="color:var(--text-muted);">No recommendations available.</p>';
    container.querySelectorAll('.add-recommended-btn').forEach(btn => {
        btn.onclick = () => addRecommendedDay(btn.getAttribute('data-day'));
    });
}
function addRecommendedDay(day) {
    const sets = getRecommendedVariantSets();
    const picks = getSessionVariantPicks(sets);
    const variants = sets[day] || [];
    if (!variants.length) return;
    const shown = variants[picks[day] ?? 0] || [];
    const exists = workoutPlan && workoutPlan[day];
    const proceed = !exists || confirm(`A plan for ${day} exists. Replace it? Click Cancel to merge.`);
    if (!workoutPlan || typeof workoutPlan !== 'object') workoutPlan = {};
    if (proceed) {
        workoutPlan[day] = shown.map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps }));
    } else {
        workoutPlan[day] = (workoutPlan[day] || []).concat(shown.map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps })));
    }
    localStorage.setItem('workoutPlan', JSON.stringify(workoutPlan));
    renderUserWorkoutPlan();
    alert('Recommended day added.');
}

function createExerciseHTML(exercise) {
    let inputsHTML = '';
    const placeholder = exercise.type === 'time' ? 'seconds' : 'kg/lbs';
    const inputType = exercise.type === 'notes' ? 'text' : 'number';

    if (exercise.type === 'notes') {
        inputsHTML = `
            <div class="input-group">
                <label for="${exercise.id}-notes">Performance Notes</label>
                <input type="${inputType}" id="${exercise.id}-notes" placeholder="e.g., time, rounds, weight">
            </div>
        `;
    } else {
        for (let i = 1; i <= exercise.sets; i++) {
            inputsHTML += `
                <div class="input-group">
                    <label for="${exercise.id}-set${i}">Set ${i}</label>
                    <input type="${inputType}" id="${exercise.id}-set${i}" placeholder="${placeholder}" ${exercise.type === 'time' ? 'inputmode="numeric" step="1" min="0" enterkeyhint="next"' : 'inputmode="decimal" step="0.5" min="0" enterkeyhint="next"'}>
                </div>
            `;
        }
    }
    
    const finisherClass = exercise.muscleGroup === 'Finisher' ? 'finisher' : '';
    return `
        <div class="exercise-card ${finisherClass}" data-exercise-id="${exercise.id}" data-exercise-type="${exercise.type}">
            <h3>${exercise.name}</h3>
            <p><strong>Target:</strong> ${exercise.sets} sets of ${exercise.reps} reps</p>
            <div class="input-grid">${inputsHTML}</div>
            ${exercise.type === 'weight' ? `<p class="suggestion" id="suggestion-${exercise.id}"></p>` : ''}
        </div>
    `;
}

function renderPhase(phaseNum) {
    const phaseKey = `p${phaseNum}`;
    const phase = workoutPlan[phaseKey];
    const mainContainer = document.querySelector('#workout-section main');
    
    if (!phase.days || Object.keys(phase.days).length === 0) {
        mainContainer.innerHTML = `<p>Workout plan for Phase ${phaseNum} has not been added yet.</p>`;
        return;
    }

    let phaseHTML = '';
    for (const dayKey in phase.days) {
        const day = phase.days[dayKey];
        phaseHTML += `
            <details class="workout-day">
                <summary>${day.title}</summary>
                <div class="workout-content" id="${phaseKey}-${dayKey}">
                    ${day.exercises.map(createExerciseHTML).join('')}
                    <button class="btn btn-secondary" onclick="saveWorkout('${phaseKey}-${dayKey}')">Save Workout</button>
                </div>
            </details>
        `;
    }
    mainContainer.innerHTML = phaseHTML;
    updateSuggestions();
}

function saveMeasurements() {
    const weight = document.getElementById('body-weight').value;
    const chest = document.getElementById('chest-measure').value;
    const waist = document.getElementById('waist-measure').value;
    const hips = document.getElementById('hips-measure').value;

    if (!weight) {
        alert('Please enter at least your body weight.');
        return;
    }

    bodyData.push({
        date: new Date().toISOString().split('T')[0],
        weight: parseFloat(weight) || null,
        chest: parseFloat(chest) || null,
        waist: parseFloat(waist) || null,
        hips: parseFloat(hips) || null,
    });
    
    // Keep data sorted by date
    bodyData.sort((a,b) => new Date(a.date) - new Date(b.date));

    localStorage.setItem('bodyTrackerData', JSON.stringify(bodyData));
    alert('Measurements saved!');
    updateBodyCompChart();
}

function saveWorkout(day) {
    const idPrefix = slugifyId(day);
    const dayContainer = document.getElementById(`workout-content-${idPrefix}`);
    let workoutLogged = false;
    dayContainer.querySelectorAll('.exercise-card').forEach(card => {
        const exerciseName = card.dataset.exerciseName;
        const idx = card.dataset.idx;
        const ex = workoutPlan[day][idx];
        const setWeights = [];
        let hasValue = false;
        const inputs = card.querySelectorAll('.set-weight-input');
        inputs.forEach(input => {
            const weight = parseFloat(input.value) || 0;
            setWeights.push(weight);
            if (weight > 0) hasValue = true;
            input.value = '';
        });
        if (hasValue) {
            if (!workoutData[exerciseName]) workoutData[exerciseName] = [];
            workoutData[exerciseName].push({
                date: new Date().toISOString().split('T')[0],
                weights: setWeights,
                sets: ex.sets,
                reps: ex.reps
            });
            workoutLogged = true;
        }
    });
    if (workoutLogged) {
        localStorage.setItem('workoutTrackerData', JSON.stringify(workoutData));
        alert('Workout saved!');
        updateSuggestions();
        updateStrengthVolumeChart();
        renderExerciseProgressCharts();
        renderUserWorkoutPlan(); // update suggestions immediately
    } else {
        alert('Please enter weight for at least one set to save.');
    }
}

function updateSuggestions() {
    document.querySelectorAll('.exercise-card[data-exercise-type="weight"]').forEach(card => {
        const exerciseId = card.dataset.exerciseId;
        const suggestionEl = document.getElementById(`suggestion-${exerciseId}`);
        const history = workoutData[exerciseId];

        if (history && history.length > 0) {
            const lastSession = history[history.length - 1];
            const src = (lastSession.weights && lastSession.weights.length ? lastSession.weights : (lastSession.values || []));
            const validWeights = src.filter(w => typeof w === 'number' && w > 0);
            if (validWeights.length > 0) {
                const maxWeight = Math.max(...validWeights);
                const suggestedWeight = maxWeight + 2.5;
                if (suggestionEl) suggestionEl.textContent = `Suggestion: Last max was ${maxWeight}. Try for ${suggestedWeight}.`;
            }
        } else {
            if (suggestionEl) suggestionEl.textContent = 'Log a workout to get suggestions.';
        }
    });
}

function showPhase(phaseNum) {
    document.querySelectorAll('.phase-btn').forEach((btn, idx) => {
        const isActive = (idx + 1) === phaseNum;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    const ws = document.getElementById('workout-section');
    ws.classList.remove('phase-1', 'phase-2', 'phase-3');
    ws.classList.add(`phase-${phaseNum}`);
    renderPhase(phaseNum);
}

// --- CHARTING FUNCTIONS ---
let exerciseCharts = {};
let _chartsInitialized = false;

function getAllExercises() {
    const exercises = {};
    // From the library
    if (typeof EXERCISE_LIBRARY !== 'undefined' && Array.isArray(EXERCISE_LIBRARY)) {
        EXERCISE_LIBRARY.forEach(ex => {
            if (!exercises[ex.name]) {
                exercises[ex.name] = { id: ex.name, name: ex.name, type: 'weight', muscleGroup: ex.muscle || 'Other' };
            }
        });
    }
    // From the workout plan
    if (workoutPlan && typeof workoutPlan === 'object') {
        for (const day in workoutPlan) {
            const list = workoutPlan[day];
            if (Array.isArray(list)) {
                list.forEach(ex => {
                    if (ex && ex.name && !exercises[ex.name]) {
                        exercises[ex.name] = { id: ex.name, name: ex.name, type: 'weight', muscleGroup: 'Other' };
                    }
                });
            }
        }
    }
    // From logged data
    if (workoutData && typeof workoutData === 'object') {
        for (const exId in workoutData) {
            if (!exercises[exId]) {
                exercises[exId] = { id: exId, name: exId, type: 'weight', muscleGroup: 'Other' };
            }
        }
    }
    return exercises;
}

// Safe stub to avoid errors in callers
function renderExerciseProgressCharts() {
    const container = document.getElementById('exercise-charts-container');
    if (!container) return;
    // Optionally clear or populate minimal content
}

function renderExerciseChart(ex, chartId) {
    const ctx = document.getElementById(chartId).getContext('2d');
    if (exerciseCharts[chartId]) exerciseCharts[chartId].destroy();
    const history = workoutData[ex.id];
    if (!history || history.length === 0) return;
    // For each session, get the max value (weight or time)
    const labels = history.map(h => new Date(h.date).toLocaleDateString());
    let data;
    if (ex.type === 'weight') {
        data = history.map(h => {
            const arr = (h.weights && h.weights.length ? h.weights : (h.values || []));
            const vals = arr.filter(v => typeof v === 'number' && v > 0);
            return vals.length ? Math.max(...vals) : 0;
        });
    } else if (ex.type === 'time') {
        data = history.map(h => {
            const arr = (h.values || []);
            const vals = arr.filter(v => typeof v === 'number' && v > 0);
            return vals.length ? Math.max(...vals) : 0;
        });
    } else {
        // For notes, just count entries
        data = history.map(h => (h.values || []).filter(v => v).length);
    }
    exerciseCharts[chartId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: ex.type === 'weight' ? 'Max Weight' : (ex.type === 'time' ? 'Max Time (s)' : 'Entries'),
                data: data,
                borderColor: 'rgba(163, 230, 53, 1)',
                backgroundColor: 'rgba(163, 230, 53, 0.2)',
                pointRadius: 4,
                pointBackgroundColor: 'rgba(100, 116, 139, 1)',
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: false }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: ex.type === 'weight' ? 'Weight' : (ex.type === 'time' ? 'Seconds' : 'Entries') } },
                x: { title: { display: true, text: 'Date' } }
            }
        }
    });
}

function updateBodyCompChart() {
    const ctx = document.getElementById('bodyCompChart').getContext('2d');
    if (bodyCompChart) bodyCompChart.destroy();
    
    if (bodyData.length === 0) return;

    const labels = bodyData.map(d => new Date(d.date).toLocaleDateString());

    bodyCompChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Body Weight (kg)',
                    data: bodyData.map(d => d.weight),
                    borderColor: 'rgba(124, 58, 237, 1)',
                    yAxisID: 'y',
                },
                {
                    label: 'Waist (cm)',
                    data: bodyData.map(d => d.waist),
                    borderColor: 'rgba(20, 184, 166, 1)',
                    yAxisID: 'y1',
                    hidden: true // Hidden by default to keep it clean
                },
                {
                    label: 'Chest (cm)',
                    data: bodyData.map(d => d.chest),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    yAxisID: 'y1',
                    hidden: true // Hidden by default
                },
                {
                    label: 'Hips (cm)',
                    data: bodyData.map(d => d.hips),
                    borderColor: 'rgba(255, 159, 64, 1)',
                    yAxisID: 'y1',
                    hidden: true // Hidden by default
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { font: { size: 12 } } },
                tooltip: { enabled: true }
            },
            layout: { padding: { left: 0, right: 0, top: 8, bottom: 8 } },
            scales: {
                x: { ticks: { font: { size: 11 }, maxRotation: 45, minRotation: 0 } },
                y: { position: 'left', title: { display: true, text: 'Weight (kg)' }, ticks: { font: { size: 12 } } },
                y1: { position: 'right', title: { display: true, text: 'Measurement (cm)' }, grid: { drawOnChartArea: false }, ticks: { font: { size: 12 } } }
            }
        }
    });
}

function updateStrengthVolumeChart() {
    const canvas = document.getElementById('strengthVolumeChart');
    if (!canvas) return; // guard: chart not present in DOM
    const ctx = canvas.getContext('2d');
    if (strengthVolumeChart) strengthVolumeChart.destroy();

    const selectedGroup = window.selectedStrengthTab || 'Legs';
    const dailyVolumes = {};

    // Find all exercises for the selected muscle group
    for (const phaseKey in workoutPlan) {
        const phase = workoutPlan[phaseKey];
        if (!phase.days) continue;
        for (const dayKey in phase.days) {
            phase.days[dayKey].exercises.forEach(ex => {
                if (ex.muscleGroup === selectedGroup && ex.type === 'weight') {
                    const history = workoutData[ex.id];
                    if (history) {
                        history.forEach(session => {
                            const arr = (session.weights && session.weights.length ? session.weights : (session.values || []));
                            const sessionVolume = arr.reduce((sum, val) => sum + (typeof val === 'number' && val > 0 ? val : 0), 0);
                            dailyVolumes[session.date] = (dailyVolumes[session.date] || 0) + sessionVolume;
                        });
                    }
                }
            });
        }
    }

    const sortedDates = Object.keys(dailyVolumes).sort((a,b) => new Date(a) - new Date(b));

    if (sortedDates.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
    }

    const labels = sortedDates.map(date => new Date(date).toLocaleDateString());
    const data = sortedDates.map(date => dailyVolumes[date]);

    strengthVolumeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: `${selectedGroup} Total Volume (kg/lbs)`,
                data: data,
                backgroundColor: 'rgba(20, 184, 166, 0.7)',
                borderColor: 'rgba(20, 184, 166, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Weight Lifted' } } }
        }
    });
}

function showStrengthTab(tab) {
    window.selectedStrengthTab = tab;
    // Highlight active tab
    ['Legs','Shoulders','Chest','Triceps','Back','Biceps'].forEach(group => {
        const btn = document.getElementById('tab-' + group);
        if (btn) btn.classList.toggle('active', group === tab);
    });
    updateStrengthVolumeChart();
}


// --- INITIALIZATION ---
function showTab(tab) {
    // Defensive: ensure tab content exists
    const dashboard = document.getElementById('main-dashboard');
    const stats = document.getElementById('main-pastworkouts');
    if (dashboard) dashboard.style.display = tab === 'workouts' ? '' : 'none';
    if (stats) stats.style.display = tab === 'stats' ? '' : 'none';
    // Tab bar active state
    const tabWorkouts = document.getElementById('tab-workouts');
    const tabStats = document.getElementById('tab-stats');
    if (tabWorkouts) tabWorkouts.classList.toggle('active', tab === 'workouts');
    if (tabStats) tabStats.classList.toggle('active', tab === 'stats');
    if (tab === 'stats') {
        if (!_chartsInitialized) {
            _chartsInitialized = true;
            if (typeof renderPastWorkoutsTable === 'function') renderPastWorkoutsTable();
            if (typeof renderWeeklyStrengthVolumeTable === 'function') renderWeeklyStrengthVolumeTable();
            if (typeof renderMeasurementsHistoryTableAndChart === 'function') renderMeasurementsHistoryTableAndChart();
            if (typeof renderExerciseProgressCharts === 'function') renderExerciseProgressCharts();
            if (typeof updateBodyCompChart === 'function') updateBodyCompChart();
        }
    }
    // Always close any open modals when switching tabs to avoid overlays blocking clicks
    const modals = ['create-plan-modal','quick-log-modal','exercise-picker-modal','user-modal','qr-share-modal','qr-scan-modal'];
    modals.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    if (typeof window.stopQrCamera === 'function') {
        try { window.stopQrCamera(); } catch {}
    }
}
window.showTab = showTab;

function renderPastWorkoutsTable() {
    const tableDiv = document.getElementById('past-workouts-table');
    if (!tableDiv) return;
    const isNarrow = window.innerWidth < 640;
    if (isNarrow) {
        // Render stacked cards for mobile
        const exercises = getAllExercises();
        let rows = [];
        for (const exId in workoutData) {
            const ex = exercises[exId] || { name: exId, type: 'weight' };
            workoutData[exId].forEach(entry => {
                const mergedValues = (entry.weights && entry.weights.length ? entry.weights : (entry.values || []));
                rows.push({ date: entry.date, exercise: ex.name, type: ex.type, values: mergedValues });
            });
        }
        rows.sort((a,b) => new Date(b.date) - new Date(a.date));
        let cards = '';
        rows.forEach(row => {
            cards += `
                <div class="mobile-pw-card">
                    <div class="pw-top"><strong>${row.exercise}</strong><span style="font-size:0.92em;color:var(--text-muted);">${row.date}</span></div>
                    <div class="pw-meta"><span>${row.type}</span><span>${row.values.map(v => v ? v : '-').join(', ')}</span></div>
                </div>
            `;
        });
        tableDiv.innerHTML = cards || '<p style="color:var(--text-muted);">No workout history available.</p>';
        return;
    }
    let html = `<table class="mobile-pastworkouts-table" style="width:100%;border-collapse:collapse;font-size:0.95em;min-width:520px;">`;
    html += `<thead><tr style="background:#f3f4f6;">
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Date</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:100px;">Exercise</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:60px;">Type</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:120px;">Values</th>
    </tr></thead><tbody>`;
    const exercises = getAllExercises();
    // Gather all workout entries
    let rows = [];
    for (const exId in workoutData) {
        const ex = exercises[exId] || { name: exId, type: 'weight' };
        workoutData[exId].forEach(entry => {
            const mergedValues = (entry.weights && entry.weights.length ? entry.weights : (entry.values || []));
            rows.push({
                date: entry.date,
                exercise: ex.name,
                type: ex.type,
                values: mergedValues
            });
        });
    }
    // Sort by date descending
    rows.sort((a,b) => new Date(b.date) - new Date(a.date));
    rows.forEach(row => {
        html += `<tr style="background:#fff;">
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:keep-all;white-space:nowrap;font-size:0.98em;">${row.date}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:120px;overflow:hidden;text-overflow:ellipsis;">${row.exercise}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:keep-all;white-space:nowrap;">${row.type}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:160px;overflow:hidden;text-overflow:ellipsis;">${row.values.map(v => v ? v : '-').join(', ')}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    tableDiv.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', function() {
    // Load data from localStorage
    const savedWorkoutData = localStorage.getItem('workoutTrackerData');
    if (savedWorkoutData) workoutData = JSON.parse(savedWorkoutData);

    const savedBodyData = localStorage.getItem('bodyTrackerData');
    if (savedBodyData) bodyData = JSON.parse(savedBodyData);

    // User details logic
    const userDetails = localStorage.getItem('userDetails');
    function setWelcomeMessage() {
        let name = '', goal = '';
        if (userDetails) {
            try {
                const details = JSON.parse(localStorage.getItem('userDetails'));
                name = details.name || '';
                goal = details.goal || '';
            } catch {}
        }
        document.getElementById('welcome-title').textContent = name ? `Welcome to Your Lifting Program, ${name}!` : 'Welcome to Your Lifting Program!';
        // Pick a random motivational message each time
        const msg = MOTIVATION_MESSAGES[Math.floor(Math.random() * MOTIVATION_MESSAGES.length)];
        document.getElementById('welcome-motivation').textContent = name && goal
            ? `Hey ${name}, your goal is "${goal}". ${msg}`
            : msg;
    }

    if (!userDetails) {
        document.getElementById('user-modal').style.display = 'flex';
        document.querySelector('.container').style.filter = 'blur(2px)';
        document.getElementById('user-details-form').onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('user-name').value.trim();
            const age = document.getElementById('user-age').value.trim();
            const goal = document.getElementById('user-goal').value.trim();
            if (!name || !age || !goal) return;
            localStorage.setItem('userDetails', JSON.stringify({ name, age, goal }));
            document.getElementById('user-modal').style.display = 'none';
            document.querySelector('.container').style.filter = '';
            setWelcomeMessage();
            showPhase(1);
            updateBodyCompChart();
            renderExerciseProgressCharts();
            showTab('workouts');
            renderWeeklyStrengthVolumeTable();
            renderMeasurementsHistoryTableAndChart();
        };
        return;
    }

    setWelcomeMessage();

    // If redirected from share target, attempt to import cached shared plan
    try {
        const url = new URL(window.location.href);
        if (url.searchParams.get('importSharedPlan') === '1') {
            fetch('shared-plan.json', { cache: 'reload' })
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    if (data && data.type === 'lifting-tracker/plan' && data.plan) {
                        localStorage.setItem('workoutPlan', JSON.stringify(data.plan));
                        workoutPlan = data.plan;
                        renderUserWorkoutPlan();
                        alert('Shared plan imported.');
                    }
                })
                .catch(() => {})
                .finally(() => {
                    // Clean up query param
                    url.searchParams.delete('importSharedPlan');
                    history.replaceState({}, document.title, url.pathname + url.search);
                });
        }
    } catch {}
    // Removed inappropriate easter egg that changed title text

    // Initial chart renders
    updateBodyCompChart();
    renderExerciseProgressCharts();
    showTab('workouts');
    renderWeeklyStrengthVolumeTable();
    renderMeasurementsHistoryTableAndChart();

    // Attach event listeners for all buttons
    // Tab navigation
    // Tab button event listeners will be attached at the end of the file for reliability

    // Floating buttons removed; actions moved to tab bar

    // Share/Import buttons removed; using QR only

    // QR Share logic
    const qrShareBtn = document.getElementById('qr-share-btn');
    const qrShareModal = document.getElementById('qr-share-modal');
    const qrShareContainer = document.getElementById('qr-share-container');
    const qrShareClose = document.getElementById('qr-share-close');
    const qrCopyString = document.getElementById('qr-copy-string');

    function closeQrShareModal() {
        if (qrShareModal) qrShareModal.style.display = 'none';
        if (qrShareContainer) qrShareContainer.innerHTML = '';
    }

    function openQrShareModal() {
        try {
            const plan = JSON.parse(localStorage.getItem('workoutPlan') || '{}');
            if (!plan || Object.keys(plan).length === 0) {
                alert('No workout plan to share. Create a plan first.');
                return;
            }
            const payload = { version: 1, type: 'lifting-tracker/plan', exportedAt: new Date().toISOString(), plan };
            const json = JSON.stringify(payload);
            const compressed = (window.LZString && LZString.compressToEncodedURIComponent) ? LZString.compressToEncodedURIComponent(json) : encodeURIComponent(json);
            const qrText = `LTQR:${compressed}`; // prefix to identify our format
            if (qrShareContainer) {
                qrShareContainer.innerHTML = '';
                const size = Math.min(300, Math.floor(window.innerWidth * 0.7));
                new QRCode(qrShareContainer, { text: qrText, width: size, height: size, correctLevel: QRCode.CorrectLevel.M });
            }
            if (qrShareModal) qrShareModal.style.display = 'flex';
            // Attach copy action
            if (qrCopyString) {
                qrCopyString.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(qrText);
                        alert('Compressed plan string copied.');
                    } catch {
                        alert('Copy failed. You can long-press to select.');
                    }
                };
            }
        } catch (e) {
            console.error('Failed to generate QR', e);
            alert('Failed to generate QR for the plan.');
        }
    }

    if (qrShareBtn) qrShareBtn.addEventListener('click', openQrShareModal);
    if (qrShareClose) qrShareClose.addEventListener('click', closeQrShareModal);

    

    // QR Scan logic
    const qrScanBtn = document.getElementById('qr-scan-btn');
    const qrScanModal = document.getElementById('qr-scan-modal');
    const qrVideo = document.getElementById('qr-video');
    const qrCanvas = document.getElementById('qr-canvas');
    const qrScanStatus = document.getElementById('qr-scan-status');
    const qrScanClose = document.getElementById('qr-scan-close');
    const qrScanRetry = document.getElementById('qr-scan-retry');
    let qrStream = null;
    let qrScanInterval = null;

    function stopQrCamera() {
        if (qrScanInterval) { clearInterval(qrScanInterval); qrScanInterval = null; }
        if (qrStream) {
            try { qrStream.getTracks().forEach(t => t.stop()); } catch {}
            qrStream = null;
        }
        if (qrVideo) {
            qrVideo.srcObject = null;
        }
        if (qrScanStatus) qrScanStatus.textContent = 'Camera stopped.';
    }
    window.stopQrCamera = stopQrCamera;

    async function startQrCamera() {
        stopQrCamera();
        try {
            if (qrScanStatus) qrScanStatus.textContent = 'Requesting camera…';
            const constraints = { video: { facingMode: 'environment' } };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            qrStream = stream;
            qrVideo.srcObject = stream;
            await qrVideo.play();
            if (qrScanStatus) qrScanStatus.textContent = 'Scanning… Hold QR steady.';
            const ctx = qrCanvas.getContext('2d');
            qrScanInterval = setInterval(() => {
                if (!qrVideo.videoWidth || !qrVideo.videoHeight) return;
                qrCanvas.width = qrVideo.videoWidth;
                qrCanvas.height = qrVideo.videoHeight;
                ctx.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
                const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const result = window.jsQR ? jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' }) : null;
                if (result && result.data) {
                    handleQrDecoded(result.data);
                }
            }, 200);
        } catch (e) {
            console.error('Camera init failed', e);
            if (qrScanStatus) qrScanStatus.textContent = 'Camera unavailable. You can share via file instead.';
        }
    }

    function closeQrScanModal() {
        if (qrScanModal) qrScanModal.style.display = 'none';
        stopQrCamera();
    }

    async function handleQrDecoded(text) {
        try {
            if (qrScanStatus) qrScanStatus.textContent = 'QR detected. Processing…';
            // Expect prefix
            let payloadStr = text || '';
            if (payloadStr.startsWith('LTQR:')) payloadStr = payloadStr.slice(5);
            let jsonStr = '';
            if (window.LZString && LZString.decompressFromEncodedURIComponent) {
                jsonStr = LZString.decompressFromEncodedURIComponent(payloadStr);
            }
            if (!jsonStr) {
                try { jsonStr = decodeURIComponent(payloadStr); } catch {}
            }
            const data = JSON.parse(jsonStr);
            if (!data || data.type !== 'lifting-tracker/plan' || typeof data.plan !== 'object') {
                if (qrScanStatus) qrScanStatus.textContent = 'Invalid QR payload.';
                return;
            }
            stopQrCamera();
            // Import strategy
            const current = JSON.parse(localStorage.getItem('workoutPlan') || '{}');
            const strategy = confirm('Import will REPLACE your current plan. Click OK to replace, or Cancel to MERGE days.');
            let nextPlan = {};
            if (strategy) {
                nextPlan = data.plan;
            } else {
                nextPlan = { ...current };
                for (const day in data.plan) nextPlan[day] = data.plan[day];
            }
            localStorage.setItem('workoutPlan', JSON.stringify(nextPlan));
            workoutPlan = nextPlan;
            renderUserWorkoutPlan();
            if (qrScanStatus) qrScanStatus.textContent = 'Plan imported successfully.';
            setTimeout(() => { alert('Plan imported successfully.'); closeQrScanModal(); }, 50);
        } catch (e) {
            console.error('QR decode/import failed', e);
            if (qrScanStatus) qrScanStatus.textContent = 'Failed to process QR.';
        }
    }

    function openQrScanModal() {
        if (qrScanModal) qrScanModal.style.display = 'flex';
        if (qrScanStatus) qrScanStatus.textContent = 'Initializing camera…';
        startQrCamera();
    }

    if (qrScanBtn) qrScanBtn.addEventListener('click', openQrScanModal);
    if (qrScanClose) qrScanClose.addEventListener('click', closeQrScanModal);
    if (qrScanRetry) qrScanRetry.addEventListener('click', startQrCamera);

    // Modal close buttons: remove inline only inside modals to avoid nuking other handlers
    document.querySelectorAll("#create-plan-modal button[type='button'][onclick], #quick-log-modal button[type='button'][onclick], #qr-share-modal button[type='button'][onclick], #qr-scan-modal button[type='button'][onclick]").forEach(btn => {
        btn.onclick = null;
    });
    // Attach close logic for modals
    document.querySelectorAll("button[type='button']").forEach(btn => {
        if (btn.textContent.trim().toLowerCase().includes('cancel')) {
            if (btn.closest('#create-plan-modal')) btn.addEventListener('click', closeCreatePlanModal);
            if (btn.closest('#quick-log-modal')) btn.addEventListener('click', closeQuickLogModal);
        }
    });
});

// Register Service Worker for PWA (if supported)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').catch(() => {});
        navigator.serviceWorker.addEventListener('message', (event) => {
            if (event && event.data && event.data.type === 'SW_UPDATED') {
                try {
                    const sb = document.getElementById('update-snackbar');
                    if (sb) sb.style.display = 'flex';
                    const reloadBtn = document.getElementById('update-reload');
                    const dismissBtn = document.getElementById('update-dismiss');
                    if (reloadBtn) reloadBtn.onclick = () => window.location.reload();
                    if (dismissBtn) dismissBtn.onclick = () => { if (sb) sb.style.display = 'none'; };
                } catch (e) { console.warn('Failed to show update snackbar', e); }
            }
        });
    });
}

// Handle PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show the install prompt immediately
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
        } else {
            console.log('User dismissed the install prompt');
        }
        deferredPrompt = null;
    });
});

function renderWeeklyStrengthVolumeTable() {
    const tableDiv = document.getElementById('weekly-strength-volume-table');
    if (!tableDiv) return;
    // Aggregate volume by week and muscle group
    const weekVolume = {};
    const exercises = getAllExercises();
    for (const exId in workoutData) {
        const ex = exercises[exId];
        if (!ex || ex.type !== 'weight') continue;
        workoutData[exId].forEach(entry => {
            const week = getWeek(entry.date);
            if (!weekVolume[week]) weekVolume[week] = {};
            if (!weekVolume[week][ex.muscleGroup]) weekVolume[week][ex.muscleGroup] = 0;
            // Sum all weights for this entry
            const arr = (entry.weights && entry.weights.length ? entry.weights : (entry.values || []));
            weekVolume[week][ex.muscleGroup] += arr.reduce((sum, v) => sum + (typeof v === 'number' && v > 0 ? v : 0), 0);
        });
    }
    // Build table for wide viewports, stacked cards for narrow screens
    const isNarrow = window.innerWidth < 640;
    const muscleGroups = ['Legs','Shoulders','Chest','Triceps','Back','Biceps','Core','Finisher'];
    const sortedWeeks = Object.keys(weekVolume).sort();

    if (isNarrow) {
        if (!sortedWeeks.length) {
            tableDiv.innerHTML = '<p style="color:var(--text-muted);">No strength data available yet.</p>';
            return;
        }
        let cards = '';
        sortedWeeks.forEach(week => {
            cards += `<div class="mobile-week-card" style="background:#fff;border:1px solid var(--border-color);border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 2px 8px rgba(44,62,80,0.04);">`;
            cards += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><strong>${week}</strong><small style="color:var(--text-muted);">Total groups: ${Object.keys(weekVolume[week]||{}).length}</small></div>`;
            cards += `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">`;
            muscleGroups.forEach(mg => {
                const val = weekVolume[week] && weekVolume[week][mg] ? weekVolume[week][mg] : 0;
                cards += `<div style="background:var(--surface-2);padding:8px;border-radius:8px;display:flex;flex-direction:column;gap:6px;">`;
                cards += `<div style="font-weight:700;">${mg}</div>`;
                cards += `<div style="color:var(--text-muted);font-size:0.95em;">${val ? val : '-'}</div>`;
                cards += `</div>`;
            });
            cards += `</div></div>`;
        });
        tableDiv.innerHTML = cards;
        return;
    }

    // Wide viewport: render table
    let html = `<table class="mobile-weeklystrength-table" style="width:100%;border-collapse:collapse;font-size:0.95em;min-width:520px;">`;
    html += `<thead><tr style="background:#f3f4f6;">
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Week</th>`;
    muscleGroups.forEach(mg => {
        html += `<th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:60px;">${mg}</th>`;
    });
    html += '</tr></thead><tbody>';
    sortedWeeks.forEach(week => {
        html += `<tr style="background:#fff;">
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:keep-all;white-space:nowrap;font-size:0.98em;">${week}</td>`;
        muscleGroups.forEach(mg => {
            html += `<td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:80px;overflow:hidden;text-overflow:ellipsis;">${weekVolume[week][mg] ? weekVolume[week][mg] : '-'}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody></table>';
    tableDiv.innerHTML = html;
}

function getWeek(dateStr) {
    // Returns YYYY-WW (ISO week)
    const date = new Date(dateStr);
    const jan1 = new Date(date.getFullYear(), 0, 1);
    const days = Math.floor((date - jan1) / (24 * 60 * 60 * 1000));
    const week = Math.ceil((days + jan1.getDay() + 1) / 7);
    return `${date.getFullYear()}-W${week.toString().padStart(2,'0')}`;
}

function renderMeasurementsHistoryTableAndChart() {
    const tableDiv = document.getElementById('measurements-history-table');
    if (!tableDiv) return;
    const isNarrow = window.innerWidth < 640;
    const latestPerDay = {};
    bodyData.forEach(row => { latestPerDay[row.date] = row; });
    const sortedRows = Object.values(latestPerDay).sort((a,b) => new Date(b.date) - new Date(a.date));
    if (isNarrow) {
        let cards = '';
        sortedRows.forEach(row => {
            cards += `
                <div class="mobile-measure-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong>${row.date}</strong>
                        <span style="color:var(--text-muted);font-size:0.95em;">${row.weight ?? '-'} kg</span>
                    </div>
                    <div class="measure-grid">
                        <div><small>Chest</small><div>${row.chest ?? '-'}</div></div>
                        <div><small>Waist</small><div>${row.waist ?? '-'}</div></div>
                        <div><small>Hips</small><div>${row.hips ?? '-'}</div></div>
                    </div>
                </div>
            `;
        });
        tableDiv.innerHTML = cards || '<p style="color:var(--text-muted);">No measurements recorded yet.</p>';
        return;
    }
    let html = `<table class="mobile-measurements-table" style="width:100%;border-collapse:collapse;font-size:0.95em;min-width:420px;">`;
    html += `<thead><tr style="background:#f3f4f6;">
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Date</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Weight (kg)</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Chest (cm)</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Waist (cm)</th>
        <th style="padding:8px 4px;border:1px solid #e2e8f0;position:sticky;top:0;z-index:2;min-width:80px;">Hips (cm)</th>
    </tr></thead><tbody>`;
    sortedRows.forEach(row => {
        html += `<tr style="background:#fff;">
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:keep-all;white-space:nowrap;font-size:0.98em;">${row.date}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:80px;overflow:hidden;text-overflow:ellipsis;">${row.weight ?? '-'}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:80px;overflow:hidden;text-overflow:ellipsis;">${row.chest ?? '-'}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:80px;overflow:hidden;text-overflow:ellipsis;">${row.waist ?? '-'}</td>
            <td style="padding:6px 4px;border:1px solid #e2e8f0;word-break:break-word;max-width:80px;overflow:hidden;text-overflow:ellipsis;">${row.hips ?? '-'}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    tableDiv.innerHTML = html;
}
</script>
<script>
// Attach tab button event listeners after everything is loaded
window.addEventListener('load', function() {
    console.log('window.load event fired, attaching tab button listeners...');
    const tabWorkoutsBtn = document.getElementById('tab-workouts');
    const tabStatsBtn = document.getElementById('tab-stats');
    const tabQuickBtn = document.getElementById('tab-quick');
    const tabCreateBtn = document.getElementById('tab-create');
    if (tabWorkoutsBtn) {
        tabWorkoutsBtn.addEventListener('click', function() {
            console.log('Workouts tab button clicked (window.load)');
            showTab('workouts');
        });
    }
    if (tabStatsBtn) {
        tabStatsBtn.addEventListener('click', function() {
            console.log('Stats tab button clicked (window.load)');
            showTab('stats');
        });
    }
    if (tabQuickBtn) {
        tabQuickBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Quick Log action clicked (window.load)');
            if (typeof openQuickLogModal === 'function') openQuickLogModal();
        });
    }
    if (tabCreateBtn) {
        tabCreateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Create Plan action clicked (window.load)');
            if (typeof openCreatePlanModal === 'function') openCreatePlanModal();
        });
    }
    console.log('Tab button event listeners attached (window.load)');
});
</script>
</body>
</html>